<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Goals Management - CanineKind Admin</title>
    <link rel="icon" type="image/x-icon" href="images/favicon.ico">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #D1E5F4 0%, #E8F4F8 100%);
            min-height: 100vh;
            padding-bottom: 40px;
        }
        .portal-header {
            background: linear-gradient(135deg, #799972 0%, #8aaa83 100%);
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        .portal-logo { display: flex; align-items: center; gap: 1rem; }
        .portal-logo img { height: 50px; width: auto; }
        .portal-logo h1 { color: white; font-size: 1.5rem; font-weight: 600; }
        .admin-badge {
            background: rgba(255, 193, 7, 0.95);
            color: #333;
            padding: 0.4rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 700;
            text-transform: uppercase;
            margin-left: 12px;
        }
        .portal-nav { display: flex; gap: 1.5rem; align-items: center; flex-wrap: wrap; }
        .portal-nav a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s;
            padding: 0.5rem 1rem;
            border-radius: 5px;
        }
        .portal-nav a:hover { background: rgba(255, 255, 255, 0.2); }
        .portal-nav a.active { background: rgba(255, 255, 255, 0.3); font-weight: 600; }
        .sign-out-link { color: rgba(255, 255, 255, 0.7); font-size: 0.85rem; }
        .container { max-width: 1400px; margin: 2rem auto; padding: 0 2rem; }
        .page-header { text-align: center; margin-bottom: 2rem; }
        .page-header h1 {
            color: #2c3e50;
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
        }
        .page-header h1::before { content: 'üéØ'; margin-right: 15px; }
        .page-header p { color: #666; font-size: 1.1rem; }
        .client-selector {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
        }
        .client-selector label {
            display: block;
            color: #2c3e50;
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 1rem;
        }
        .client-selector select {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            background: white;
            cursor: pointer;
        }
        .goals-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
        .goals-section {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 3px solid #f0f0f0;
        }
        .section-header h2 { color: #2c3e50; font-size: 1.4rem; font-weight: 800; }
        .level-section { margin-bottom: 1.5rem; }
        .level-header {
            background: linear-gradient(135deg, #799972 0%, #8aaa83 100%);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-weight: 700;
            margin-bottom: 0.75rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .level-content { display: none; }
        .level-content.open { display: block; }
        .goal-item {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }
        .goal-info { flex: 1; }
        .goal-title { font-weight: 600; color: #2c3e50; margin-bottom: 0.25rem; }
        .goal-desc { font-size: 0.85rem; color: #666; }
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85rem;
        }
        .btn-add { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
        .btn-remove { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; }
        .btn-primary {
            background: linear-gradient(135deg, #799972 0%, #8aaa83 100%);
            color: white;
            padding: 0.75rem 2rem;
            font-size: 1rem;
        }
        .custom-goal-form {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 10px;
            margin-top: 1rem;
        }
        .form-group { margin-bottom: 1rem; }
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #2c3e50;
        }
        input, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-family: inherit;
        }
        textarea { min-height: 100px; resize: vertical; }
        .empty-state { text-align: center; padding: 3rem; color: #999; }
        @media (max-width: 1024px) { .goals-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <header class="portal-header">
        <div class="header-content">
            <div class="portal-logo">
                <img src="https://i.imgur.com/OXiQWa3.jpeg" alt="CanineKind Logo">
                <h1>Admin Portal<span class="admin-badge">ADMIN</span></h1>
            </div>
            <nav class="portal-nav">
                <a href="portal-admin-dashboard.html">Dashboard</a>
                <a href="portal-admin-user-approval.html">User Approval</a>
                <a href="portal-admin-sessions.html">Sessions</a>
                <a href="portal-admin-goals.html" class="active">Goals</a>
                <a href="portal-admin-settings.html">Settings</a>
                <a href="portal-admin-forms.html">Forms</a>
                <a href="portal-admin-schedule.html">Schedule Activity</a>
                <a href="portal-dashboard.html" style="background: rgba(255, 193, 7, 0.25); border: 2px solid rgba(255, 193, 7, 0.6); border-radius: 8px; font-weight: 600;">üëÅÔ∏è View as Client</a>
                <a href="#" class="sign-out-link" onclick="signOut(); return false;">Sign Out</a>
            </nav>
        </div>
    </header>

    <div class="container">
        <div class="page-header">
            <h1>Goals Management</h1>
            <p>Manage client training goals and create custom objectives</p>
        </div>

        <div class="client-selector">
            <label>Select Client to Manage</label>
            <select id="clientSelect" onchange="loadClientGoals()">
                <option value="">-- Choose a client --</option>
            </select>
        </div>

        <div id="goalsContainer">
            <div class="empty-state">
                <div style="font-size: 4rem; margin-bottom: 1rem;">üëÜ</div>
                <p>Select a client above to manage their training goals</p>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script>
        let currentUser = null;
        let selectedClientEmail = null;
        let clientGoals = {};
        
        const GOALS_STRUCTURE = {
            0: [
                { id: 'training-gear', title: 'Training Gear Checklist', description: 'Get all necessary training equipment', tasks: ['Gear ready'] },
                { id: 'legal-forms', title: 'Sign Legal Forms', description: 'Complete required documentation', tasks: ['Forms completed'] },
                { id: 'review-instructions', title: 'Review Email Instructions', description: 'Review pre-session guidance', tasks: ['Instructions reviewed'] }
            ],
            1: [
                { id: 'crate-manners-1', title: 'Crate Manners', description: 'Basic crate training and comfort', tasks: ['Enter crate willingly', 'Calm in crate for 10 minutes', 'No whining or barking'] },
                { id: 'boundaries-thresholds-1', title: 'Boundaries and Thresholds', description: 'Wait at doors and boundaries', tasks: ['Wait at front door', 'Wait at gate/threshold', 'Release on command'] },
                { id: 'sit-1', title: 'Sit', description: 'Master sit command', tasks: ['Sit with hand signal', 'Sit for 10 seconds', 'Sit with mild distractions'] },
                { id: 'down-1', title: 'Down', description: 'Lie down on command', tasks: ['Down with signal', 'Hold down 10 seconds', 'Down from any position'] },
                { id: 'markers-release-1', title: 'Markers & Release', description: 'Understand marker words and release cues', tasks: ['Respond to "Yes" marker', 'Understand "Break" release', 'Wait for release from commands'] },
                { id: 'leave-it-1', title: 'Leave It', description: 'Ignore objects on command', tasks: ['Leave treat in hand', 'Leave treat on floor', 'Walk past distractions'] },
                { id: 'place-1', title: 'Place', description: 'Go to designated spot', tasks: ['Go to place', 'Stay on place 30 seconds', 'Place with mild distractions'] }
            ],
            2: [
                { id: 'crate-manners-2', title: 'Crate Manners', description: 'Extended crate training with distractions', tasks: ['Calm in crate for 30 minutes', 'No reactivity to household movement', 'Settle quickly when crated'] },
                { id: 'boundaries-thresholds-2', title: 'Boundaries and Thresholds', description: 'Wait at all doorways with distractions', tasks: ['Wait at all doors consistently', 'Wait with people passing by', 'Hold position until released'] },
                { id: 'sit-2', title: 'Sit', description: 'Reliable sit with distractions', tasks: ['Sit with moderate distractions', 'Sit from distance (10 feet)', 'Sit duration 30 seconds'] },
                { id: 'down-2', title: 'Down', description: 'Reliable down with distractions', tasks: ['Down with moderate distractions', 'Down from distance (10 feet)', 'Hold down 30 seconds'] },
                { id: 'markers-release-2', title: 'Markers & Release', description: 'Advanced marker understanding', tasks: ['Multiple markers in sequence', 'Maintain position until release', 'Generalize to different environments'] },
                { id: 'leave-it-2', title: 'Leave It', description: 'Advanced leave it command', tasks: ['Leave food on ground while walking', 'Leave people/dogs approaching', 'Leave it at distance'] },
                { id: 'place-2', title: 'Place', description: 'Extended place command', tasks: ['Place for 2 minutes', 'Place with household distractions', 'Send to place from distance'] },
                { id: 'toy-ball-out-2', title: 'Toy-Ball Out', description: 'Drop and release toys on command', tasks: ['Drop toy in hand', 'Out command with ball', 'Release without hesitation'] }
            ],
            3: [
                { id: 'crate-manners-3', title: 'Crate Manners', description: 'Master level crate behavior', tasks: ['Calm in crate 1+ hour', 'Settle immediately when crated', 'No reactivity to any distractions'] },
                { id: 'boundaries-thresholds-3', title: 'Boundaries and Thresholds', description: 'Automatic wait at all boundaries', tasks: ['Auto-sit at all thresholds', 'Wait with high distractions', 'Generalize to new locations'] },
                { id: 'sit-3', title: 'Sit', description: 'Master sit under all conditions', tasks: ['Sit with high distractions', 'Distance sit (20+ feet)', 'Duration sit 1+ minute'] },
                { id: 'down-3', title: 'Down', description: 'Master down under all conditions', tasks: ['Down with high distractions', 'Distance down (20+ feet)', 'Hold down 1+ minute'] },
                { id: 'markers-release-3', title: 'Markers & Release', description: 'Master marker system', tasks: ['Complex marker sequences', 'Multiple behaviors before release', 'Works in all environments'] },
                { id: 'leave-it-3', title: 'Leave It', description: 'Master level leave it', tasks: ['Leave high-value items', 'Leave it off-leash', 'Auto leave-it (no command needed)'] },
                { id: 'place-3', title: 'Place', description: 'Master place command', tasks: ['Place for 5+ minutes', 'Place in public settings', 'Remote send to place'] },
                { id: 'toy-ball-out-3', title: 'Toy-Ball Out', description: 'Immediate release of any item', tasks: ['Out with high-value items', 'Out during play excitement', 'Out at distance'] }
            ],
            4: [
                { id: 'crate-manners-4', title: 'Crate Manners', description: 'Expert crate behavior in all situations', tasks: ['Extended duration (2+ hours)', 'Calm in unfamiliar crates', 'Competition-level crate manners'] },
                { id: 'boundaries-thresholds-4', title: 'Boundaries and Thresholds', description: 'Perfect threshold control', tasks: ['Auto-wait in all scenarios', 'Wait with extreme distractions', 'Maintain in novel environments'] },
                { id: 'sit-4', title: 'Sit', description: 'Competition level sit', tasks: ['Immediate sit response', 'Distance sit (50+ feet)', 'Duration sit 2+ minutes'] },
                { id: 'down-4', title: 'Down', description: 'Competition level down', tasks: ['Immediate down response', 'Distance down (50+ feet)', 'Duration down 2+ minutes'] },
                { id: 'markers-release-4', title: 'Markers & Release', description: 'Expert marker system', tasks: ['Perfect timing recognition', 'Chain multiple behaviors', 'Works in competition settings'] },
                { id: 'leave-it-4', title: 'Leave It', description: 'Expert leave it command', tasks: ['Leave it in extreme scenarios', 'Generalized auto leave-it', 'Competition-level reliability'] },
                { id: 'place-4', title: 'Place', description: 'Expert place command', tasks: ['Extended place (10+ minutes)', 'Place in competition settings', 'Multiple place positions'] },
                { id: 'toy-ball-out-4', title: 'Toy-Ball Out', description: 'Expert release command', tasks: ['Instant out response', 'Out in any scenario', 'Competition-level reliability'] },
                { id: 'long-distance-4', title: 'Long Distance Commands', description: 'Commands at extreme distance', tasks: ['Commands at 100+ feet', 'Visual signals only', 'Reliable in all environments'] }
            ],
            5: [
                { id: 'dog-neutrality-1', title: 'Dog Neutrality Level 1', description: 'Basic calm behavior around dogs', tasks: ['Notice dog without reacting', 'Walk past dog at 20 feet', 'Maintain focus on handler'] },
                { id: 'dog-neutrality-2', title: 'Dog Neutrality Level 2', description: 'Improved calm behavior around dogs', tasks: ['Walk past dog at 10 feet', 'Hold sit-stay with dog nearby', 'Respond to commands near dogs'] },
                { id: 'dog-neutrality-3', title: 'Dog Neutrality Level 3', description: 'Expert neutrality around dogs', tasks: ['Walk past dog at 5 feet or less', 'Ignore off-leash dogs', 'Maintain neutrality with barking dogs'] }
            ],
            6: [
                { id: 'human-neutrality-1', title: 'Human Neutrality Level 1', description: 'Basic calm behavior around people', tasks: ['Walk past stranger at 10 feet', 'No jumping on people', 'Maintain loose leash near people'] },
                { id: 'human-neutrality-2', title: 'Human Neutrality Level 2', description: 'Improved calm behavior around people', tasks: ['Ignore people approaching', 'Calm when people pet/touch', 'Maintain focus in crowds'] },
                { id: 'human-neutrality-3', title: 'Human Neutrality Level 3', description: 'Expert neutrality around people', tasks: ['Perfect manners with children', 'Ignore running/playing people', 'Calm in very crowded areas'] }
            ],
            7: [
                { id: 'trigger-neutrality-1', title: 'General Trigger Neutrality Level 1', description: 'Basic desensitization to common triggers', tasks: ['Calm with basic sounds (doorbell, etc)', 'Ignore moving objects (bikes, etc)', 'Settle during household activity'] },
                { id: 'trigger-neutrality-2', title: 'General Trigger Neutrality Level 2', description: 'Improved trigger management', tasks: ['Calm with loud noises', 'Ignore fast-moving triggers', 'Maintain training near triggers'] },
                { id: 'trigger-neutrality-3', title: 'General Trigger Neutrality Level 3', description: 'Expert trigger neutrality', tasks: ['No reaction to any common trigger', 'Generalized neutrality', 'Proactive calming behavior'] }
            ],
            8: [
                { id: 'loose-leash-1', title: 'Loose Leash Walking Level 1', description: 'Foundation leash walking skills', tasks: ['Walk without pulling (short distances)', 'Respond to direction changes', 'Check in with handler'] },
                { id: 'loose-leash-2', title: 'Loose Leash Walking Level 2', description: 'Reliable loose leash walking', tasks: ['Walk without pulling (medium distances)', 'Loose leash with mild distractions', 'Heel position awareness'] },
                { id: 'loose-leash-3', title: 'Loose Leash Walking Level 3', description: 'Master loose leash walking', tasks: ['Perfect loose leash in all environments', 'Heel position on command', 'No pulling with any distractions'] }
            ]
        };

        const LEVEL_DESCRIPTIONS = {
            0: 'Onboarding',
            1: 'Basic Obedience',
            2: 'Intermediate Obedience',
            3: 'Advanced Obedience',
            4: 'Master Obedience',
            5: 'Dog Neutrality',
            6: 'Human Neutrality',
            7: 'General Trigger Neutrality',
            8: 'Loose Leash Walking'
        };

        document.addEventListener('DOMContentLoaded', async () => {
            const initialized = initializeFirebase();
            if (!initialized) {
                alert('Failed to initialize Firebase');
                window.location.href = 'portal-login.html';
                return;
            }

            auth.onAuthStateChanged(async (user) => {
                if (!user) {
                    window.location.href = 'portal-login.html';
                } else {
                    const isAdmin = await isUserAdmin();
                    if (!isAdmin) {
                        alert('Access denied. Admin privileges required.');
                        window.location.href = 'portal-dashboard.html';
                        return;
                    }
                    currentUser = user;
                    await loadClients();
                }
            });
        });

        async function isUserAdmin() {
            try {
                const userDoc = await db.collection('users').doc(auth.currentUser.email).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    return userData.admin === true || userData.isAdmin === true || userData.role === 'admin';
                }
                return false;
            } catch (error) {
                console.error('Error checking admin status:', error);
                return false;
            }
        }

        async function loadClients() {
            try {
                const usersSnapshot = await db.collection('users').where('approved', '==', true).get();
                const select = document.getElementById('clientSelect');
                let options = '<option value="">-- Choose a client --</option>';
                usersSnapshot.docs.forEach(doc => {
                    const userData = doc.data();
                    const displayName = userData.displayName || userData.name || doc.id;
                    options += '<option value="' + doc.id + '">' + displayName + ' (' + doc.id + ')</option>';
                });
                select.innerHTML = options;
            } catch (error) {
                console.error('Error loading clients:', error);
            }
        }

        async function loadClientGoals() {
            const email = document.getElementById('clientSelect').value;
            if (!email) {
                document.getElementById('goalsContainer').innerHTML = '<div class="empty-state"><div style="font-size: 4rem; margin-bottom: 1rem;">üëÜ</div><p>Select a client above</p></div>';
                return;
            }

            selectedClientEmail = email;

            try {
                const goalsSnapshot = await db.collection('users').doc(uid).collection('selectedGoals').get();
                clientGoals = {};
                goalsSnapshot.docs.forEach(doc => {
                    clientGoals[doc.id] = { id: doc.id, ...doc.data() };
                });

                const customGoalsSnapshot = await db.collection('users').doc(uid).collection('customGoals').get();
                const customGoals = {};
                customGoalsSnapshot.docs.forEach(doc => {
                    customGoals[doc.id] = { id: doc.id, ...doc.data() };
                });

                renderGoalsInterface(customGoals);
            } catch (error) {
                console.error('Error loading client goals:', error);
                alert('Error loading goals');
            }
        }

        function renderGoalsInterface(customGoals) {
            let html = '<div class="goals-grid">';
            html += '<div class="goals-section"><div class="section-header"><h2>Available Goals</h2></div>';
            
            for (let level = 0; level <= 8; level++) {
                const goals = GOALS_STRUCTURE[level];
                if (!goals || goals.length === 0) continue;

                // Levels 5-8 are standalone categories without level numbers
                const isStandaloneCategory = level >= 5;

                html += '<div class="level-section">';
                html += '<div class="level-header" onclick="toggleLevel(' + level + ')">';
                if (isStandaloneCategory) {
                    html += '<span>' + LEVEL_DESCRIPTIONS[level] + '</span>';
                } else {
                    html += '<span>Level ' + level + ': ' + LEVEL_DESCRIPTIONS[level] + '</span>';
                }
                html += '<span>' + goals.length + ' goals</span></div>';
                html += '<div class="level-content" id="level-' + level + '">';

                goals.forEach(goal => {
                    const isAssigned = clientGoals.hasOwnProperty(goal.id);
                    html += '<div class="goal-item"><div class="goal-info">';
                    html += '<div class="goal-title">' + goal.title + '</div>';
                    html += '<div class="goal-desc">' + (goal.description || '') + '</div></div>';
                    if (isAssigned) {
                        html += '<button class="btn btn-remove" onclick="removeGoal(\'' + goal.id + '\', ' + level + ')">‚úï Remove</button>';
                    } else {
                        html += '<button class="btn btn-add" onclick="addGoal(\'' + goal.id + '\', ' + level + ')">+ Add</button>';
                    }
                    html += '</div>';
                });

                html += '</div></div>';
            }
            html += '</div>';

            html += '<div class="goals-section"><div class="section-header"><h2>Client Goals</h2></div>';
            const assignedGoals = Object.values(clientGoals);
            if (assignedGoals.length === 0) {
                html += '<div class="empty-state"><p>No goals assigned</p></div>';
            } else {
                assignedGoals.forEach(goal => {
                    const progress = goal.progress || 0;
                    html += '<div class="goal-item"><div class="goal-info">';
                    html += '<div class="goal-title">' + goal.title + '</div>';
                    html += '<div class="goal-desc">Progress: ' + progress + '%</div></div>';
                    html += '<button class="btn btn-remove" onclick="removeGoal(\'' + goal.id + '\', ' + (goal.level || 0) + ')">‚úï</button></div>';
                });
            }

            html += '<div class="section-header" style="margin-top: 2rem;"><h2>Custom Goals</h2></div>';
            const customGoalsList = Object.values(customGoals);
            if (customGoalsList.length > 0) {
                customGoalsList.forEach(goal => {
                    html += '<div class="goal-item"><div class="goal-info">';
                    html += '<div class="goal-title">' + goal.title + '</div>';
                    html += '<div class="goal-desc">' + (goal.description || '') + '</div></div>';
                    html += '<button class="btn btn-remove" onclick="removeCustomGoal(\'' + goal.id + '\')">‚úï</button></div>';
                });
            }

            html += '<div class="custom-goal-form">';
            html += '<h3 style="margin-bottom: 1rem; color: #2c3e50;">Create Custom Goal</h3>';
            html += '<div class="form-group"><label>Goal Title</label>';
            html += '<input type="text" id="customGoalTitle" placeholder="e.g., Fetch Training"></div>';
            html += '<div class="form-group"><label>Description</label>';
            html += '<textarea id="customGoalDesc" placeholder="Describe this goal..."></textarea></div>';
            html += '<div class="form-group"><label>Milestones (one per line)</label>';
            html += '<textarea id="customGoalTasks" placeholder="Learn to drop ball\nFetch from 10 feet\nFetch and return"></textarea></div>';
            html += '<button class="btn btn-primary" onclick="createCustomGoal()" style="width: 100%;">+ Create Custom Goal</button>';
            html += '</div></div></div>';

            document.getElementById('goalsContainer').innerHTML = html;
        }

        function toggleLevel(level) {
            const content = document.getElementById('level-' + level);
            if (content.classList.contains('open')) {
                content.classList.remove('open');
            } else {
                content.classList.add('open');
            }
        }

        async function addGoal(goalId, level) {
            if (!selectedClientEmail) return;
            const goalTemplate = GOALS_STRUCTURE[level].find(g => g.id === goalId);
            if (!goalTemplate) return;

            const goalData = {
                ...goalTemplate,
                level: level,
                selectedAt: firebase.firestore.FieldValue.serverTimestamp(),
                progress: 0,
                tasks: goalTemplate.tasks.map(task => ({ text: task, completed: false }))
            };

            try {
                await db.collection('users').doc(selectedClientEmail).collection('selectedGoals').doc(goalId).set(goalData);
                alert('Goal "' + goalTemplate.title + '" added!');
                await loadClientGoals();
            } catch (error) {
                console.error('Error adding goal:', error);
                alert('Error adding goal');
            }
        }

        async function removeGoal(goalId, level) {
            if (!selectedClientEmail) return;
            if (!confirm('Remove this goal?')) return;

            try {
                await db.collection('users').doc(selectedClientEmail).collection('selectedGoals').doc(goalId).delete();
                alert('Goal removed!');
                await loadClientGoals();
            } catch (error) {
                console.error('Error removing goal:', error);
                alert('Error removing goal');
            }
        }

        async function createCustomGoal() {
            if (!selectedClientEmail) return;

            const title = document.getElementById('customGoalTitle').value.trim();
            const description = document.getElementById('customGoalDesc').value.trim();
            const tasksText = document.getElementById('customGoalTasks').value.trim();

            if (!title) { alert('Please enter a goal title'); return; }

            const tasks = tasksText.split('\n').filter(t => t.trim()).map(t => t.trim());
            if (tasks.length === 0) { alert('Please enter at least one milestone'); return; }

            const customGoalData = {
                title: title,
                description: description,
                tasks: tasks.map(task => ({ text: task, completed: false })),
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: currentUser.email,
                progress: 0,
                isCustom: true
            };

            try {
                await db.collection('users').doc(selectedClientEmail).collection('customGoals').add(customGoalData);
                alert('Custom goal "' + title + '" created!');
                document.getElementById('customGoalTitle').value = '';
                document.getElementById('customGoalDesc').value = '';
                document.getElementById('customGoalTasks').value = '';
                await loadClientGoals();
            } catch (error) {
                console.error('Error creating custom goal:', error);
                alert('Error creating custom goal');
            }
        }

        async function removeCustomGoal(goalId) {
            if (!selectedClientEmail) return;
            if (!confirm('Remove this custom goal?')) return;

            try {
                await db.collection('users').doc(selectedClientEmail).collection('customGoals').doc(goalId).delete();
                alert('Custom goal removed!');
                await loadClientGoals();
            } catch (error) {
                console.error('Error:', error);
                alert('Error removing custom goal');
            }
        }

        function signOut() {
            auth.signOut().then(() => { window.location.href = 'portal-login.html'; });
        }
    </script>
</body>
</html>
