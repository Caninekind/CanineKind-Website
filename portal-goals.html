<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Training Goals - CanineKind Client Portal</title>
    <link rel="icon" type="image/x-icon" href="images/favicon.ico">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #D1E5F4 0%, #E8F4F8 100%);
            min-height: 100vh;
            padding-bottom: 40px;
        }

        .portal-header {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .portal-logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .portal-logo img {
            height: 50px;
            width: auto;
        }

        .portal-logo h1 {
            color: #799972;
            font-size: 1.5rem;
        }

        .portal-nav {
            display: flex;
            gap: 2rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .portal-nav a {
            color: #333;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
            padding: 0.5rem 1rem;
            border-radius: 5px;
        }

        .portal-nav a:hover {
            color: #799972;
            background: #f0f0f0;
        }

        .portal-nav a.active {
            color: #799972;
            background: #e8f5e9;
            font-weight: 600;
        }

        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .page-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .page-header h1 {
            color: #333;
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .page-header p {
            color: #666;
            font-size: 1.1rem;
        }

        .admin-notice {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 2rem;
            font-weight: 500;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .goals-section {
            display: grid;
            gap: 2rem;
        }

        .section-card {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .section-card h2 {
            color: #333;
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .available-goals {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }

        .goal-card {
            padding: 1.5rem;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
            position: relative;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .goal-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .goal-card.selected {
            border-color: #799972;
            box-shadow: 0 6px 20px rgba(121, 153, 114, 0.4);
        }

        /* Goal colors - bubbly gradients */
        .goal-leash { background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%); }
        .goal-barking { background: linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%); }
        .goal-crate-barking { background: linear-gradient(135deg, #fddb92 0%, #d1fdff 100%); }
        .goal-potty { background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%); }
        .goal-recall { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .goal-sit { background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%); }
        .goal-stay { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .goal-down { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .goal-heel { background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); }
        .goal-socialization { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .goal-separation { background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); color: white; }

        .goal-card h3 {
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
            color: #1a1a1a;
        }

        .goal-card.goal-separation h3,
        .goal-card.goal-separation p {
            color: white;
        }

        .goal-card p {
            font-size: 0.9rem;
            color: #333;
            line-height: 1.5;
        }

        .goal-card .check-icon {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5rem;
            display: none;
        }

        .goal-card.selected .check-icon {
            display: block;
        }

        .request-btn {
            margin-top: 1.5rem;
            padding: 1rem 2rem;
            background: #799972;
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(121, 153, 114, 0.3);
            width: 100%;
        }

        .request-btn:hover {
            background: #6a8862;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(121, 153, 114, 0.4);
        }

        .request-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .my-goals-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .my-goal-item {
            padding: 1.5rem;
            border-radius: 15px;
            background: white;
            border: 2px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .my-goal-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .goal-info {
            flex: 1;
        }

        .goal-info h3 {
            color: #333;
            font-size: 1.2rem;
            margin-bottom: 0.3rem;
        }

        .goal-info p {
            color: #666;
            font-size: 0.9rem;
        }

        .goal-status {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        .status-pending {
            background: #fff4e6;
            color: #e65100;
        }

        .status-approved {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .status-active {
            background: #e3f2fd;
            color: #1565c0;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #999;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .loading-overlay.active {
            display: flex;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #799972;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .admin-panel {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .admin-panel h2 {
            color: white;
            margin-bottom: 1.5rem;
        }

        .pending-requests {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .request-item {
            background: white;
            color: #333;
            padding: 1.5rem;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .request-info {
            flex: 1;
        }

        .request-info .client-email {
            font-weight: 600;
            color: #799972;
            margin-bottom: 0.3rem;
        }

        .request-info .goal-title {
            font-size: 1.1rem;
            font-weight: 500;
        }

        .request-actions {
            display: flex;
            gap: 0.5rem;
        }

        .approve-btn, .deny-btn {
            padding: 0.5rem 1.5rem;
            border: none;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .approve-btn {
            background: #51cf66;
            color: white;
        }

        .approve-btn:hover {
            background: #40c057;
            transform: translateY(-2px);
        }

        .deny-btn {
            background: #ff6b6b;
            color: white;
        }

        .deny-btn:hover {
            background: #fa5252;
            transform: translateY(-2px);
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .portal-nav {
                gap: 0.5rem;
                font-size: 0.9rem;
                justify-content: center;
                flex-wrap: wrap;
            }

            .portal-nav a {
                padding: 0.4rem 0.8rem;
                font-size: 0.85rem;
            }

            .page-header h1 {
                font-size: 2rem;
            }

            .page-header p {
                font-size: 1rem;
            }

            .available-goals {
                grid-template-columns: 1fr;
            }

            .my-goal-item {
                flex-direction: column;
                align-items: flex-start;
            }

            .request-item {
                flex-direction: column;
                align-items: flex-start;
            }

            .goal-card {
                padding: 1.25rem;
            }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <header class="portal-header">
        <div class="header-content">
            <div class="portal-logo">
                <img src="https://i.imgur.com/OXiQWa3.jpeg" alt="CanineKind Logo">
                <h1>Client Portal</h1>
            </div>
            <nav class="portal-nav">
                <a href="portal-dashboard.html">Dashboard</a>
                <a href="portal-sessions.html">Sessions</a>
                <a href="portal-forms.html">Forms & Documents</a>
                <a href="portal-schedule.html">Daily Schedule</a>
                <a href="portal-goals.html" class="active">Goals</a>
                <a href="#" onclick="signOut(); return false;">Sign Out</a>
            </nav>
        </div>
    </header>

    <div class="container">
        <div class="page-header">
            <h1>üéØ Training Goals</h1>
            <p>Select goals for your dog's training journey</p>
        </div>

        <div class="admin-notice">
            ‚ÑπÔ∏è Goals require admin approval before they become active
        </div>

        <!-- Admin Panel (only visible to admins) -->
        <div id="adminPanel" style="display: none;"></div>

        <div class="goals-section">
            <!-- My Active Goals -->
            <div class="section-card">
                <h2>üìã My Goals</h2>
                <div class="my-goals-list" id="myGoalsList">
                    <div class="empty-state">
                        <div class="empty-state-icon">üéØ</div>
                        <p>No goals added yet. Select from available goals below!</p>
                    </div>
                </div>
            </div>

            <!-- Available Goals to Request -->
            <div class="section-card">
                <h2>üåü Available Goals</h2>
                <p style="margin-bottom: 1.5rem; color: #666;">Click on a goal to select it, then request approval from your trainer.</p>
                <div class="available-goals" id="availableGoals"></div>
                <button class="request-btn" id="requestBtn" onclick="requestGoals()" disabled>
                    Request Selected Goals
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- Firebase Config -->
    <script src="firebase-config.js"></script>
    <script>
        let currentUser = null;
        let isAdmin = false;
        let selectedGoals = [];
        let myGoals = [];

        const availableGoalsList = [
            {
                id: 'loose-leash',
                title: 'Loose Leash Walking',
                description: 'Train your dog to walk calmly on a leash without pulling',
                class: 'goal-leash',
                emoji: 'ü¶Æ'
            },
            {
                id: 'door-barking',
                title: 'Address Door/Window Barking',
                description: 'Reduce excessive barking at doors and windows',
                class: 'goal-barking',
                emoji: 'üîï'
            },
            {
                id: 'crate-barking',
                title: 'Crate Barking',
                description: 'Help your dog stay calm and quiet in their crate',
                class: 'goal-crate-barking',
                emoji: 'üè†'
            },
            {
                id: 'crate-potty',
                title: 'Crate Potty Training',
                description: 'Establish proper potty habits with crate training',
                class: 'goal-potty',
                emoji: 'üöΩ'
            },
            {
                id: 'recall',
                title: 'Reliable Recall',
                description: 'Train your dog to come when called every time',
                class: 'goal-recall',
                emoji: 'üì£'
            },
            {
                id: 'sit',
                title: 'Sit Command',
                description: 'Master the fundamental sit command',
                class: 'goal-sit',
                emoji: 'ü™ë'
            },
            {
                id: 'stay',
                title: 'Stay Command',
                description: 'Train your dog to stay in place on command',
                class: 'goal-stay',
                emoji: '‚úã'
            },
            {
                id: 'down',
                title: 'Down Command',
                description: 'Teach your dog to lie down on command',
                class: 'goal-down',
                emoji: '‚¨áÔ∏è'
            },
            {
                id: 'heel',
                title: 'Heel Command',
                description: 'Train your dog to walk closely by your side',
                class: 'goal-heel',
                emoji: 'üëü'
            },
            {
                id: 'socialization',
                title: 'Dog Socialization',
                description: 'Improve interactions with other dogs',
                class: 'goal-socialization',
                emoji: 'üêï'
            },
            {
                id: 'separation',
                title: 'Separation Anxiety',
                description: 'Help your dog feel comfortable when alone',
                class: 'goal-separation',
                emoji: 'üíô'
            }
        ];

        // Wait for Firebase to load
        function waitForFirebase() {
            return new Promise((resolve) => {
                if (typeof firebase !== 'undefined') {
                    resolve();
                } else {
                    const checkInterval = setInterval(() => {
                        if (typeof firebase !== 'undefined') {
                            clearInterval(checkInterval);
                            resolve();
                        }
                    }, 100);
                }
            });
        }

        document.addEventListener('DOMContentLoaded', async () => {
            // Wait for Firebase SDK to load
            await waitForFirebase();

            const initialized = initializeFirebase();
            if (!initialized) {
                window.location.href = 'portal-login.html';
                return;
            }

            auth.onAuthStateChanged(async (user) => {
                if (!user) {
                    window.location.href = 'portal-login.html';
                } else {
                    const approval = await checkUserApproval(user.email);
                    if (!approval.approved) {
                        window.location.href = 'portal-pending.html';
                    } else {
                        currentUser = user;
                        isAdmin = approval.role === 'admin';
                        await loadGoals();
                        renderAvailableGoals();
                        if (isAdmin) {
                            await loadAdminPanel();
                        }
                    }
                }
            });
        });

        function renderAvailableGoals() {
            const container = document.getElementById('availableGoals');
            container.innerHTML = availableGoalsList.map(goal => `
                <div class="goal-card ${goal.class}" onclick="toggleGoal('${goal.id}')">
                    <span class="check-icon">‚úÖ</span>
                    <h3>${goal.emoji} ${goal.title}</h3>
                    <p>${goal.description}</p>
                </div>
            `).join('');
        }

        function toggleGoal(goalId) {
            const goalCard = event.currentTarget;
            const isSelected = goalCard.classList.contains('selected');

            if (isSelected) {
                goalCard.classList.remove('selected');
                selectedGoals = selectedGoals.filter(id => id !== goalId);
            } else {
                goalCard.classList.add('selected');
                selectedGoals.push(goalId);
            }

            document.getElementById('requestBtn').disabled = selectedGoals.length === 0;
        }

        async function loadGoals() {
            showLoading(true);
            try {
                const goalsSnapshot = await db.collection('users')
                    .doc(currentUser.email)
                    .collection('goals')
                    .get();

                myGoals = goalsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                renderMyGoals();
            } catch (error) {
                console.error('Error loading goals:', error);
                alert('Error loading goals');
            } finally {
                showLoading(false);
            }
        }

        function renderMyGoals() {
            const container = document.getElementById('myGoalsList');

            if (myGoals.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üéØ</div>
                        <p>No goals added yet. Select from available goals below!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = myGoals.map(goal => {
                const goalData = availableGoalsList.find(g => g.id === goal.goalId);
                const statusClass = goal.status === 'approved' ? 'status-approved' : 'status-pending';
                const statusText = goal.status === 'approved' ? '‚úÖ Active' : '‚è≥ Pending Approval';

                return `
                    <div class="my-goal-item">
                        <div class="goal-info">
                            <h3>${goalData?.emoji || 'üéØ'} ${goal.title}</h3>
                            <p>Requested: ${new Date(goal.requestedAt?.toDate()).toLocaleDateString()}</p>
                        </div>
                        <div class="goal-status ${statusClass}">
                            ${statusText}
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function requestGoals() {
            if (selectedGoals.length === 0) return;

            showLoading(true);
            try {
                const batch = db.batch();

                for (const goalId of selectedGoals) {
                    const goalData = availableGoalsList.find(g => g.id === goalId);
                    const goalRef = db.collection('users')
                        .doc(currentUser.email)
                        .collection('goals')
                        .doc();

                    batch.set(goalRef, {
                        goalId: goalId,
                        title: goalData.title,
                        description: goalData.description,
                        status: 'pending',
                        requestedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        clientEmail: currentUser.email,
                        clientName: currentUser.displayName || currentUser.email
                    });
                }

                await batch.commit();

                alert(`Successfully requested ${selectedGoals.length} goal(s)! Your trainer will review and approve them. ‚úÖ`);

                selectedGoals = [];
                document.querySelectorAll('.goal-card.selected').forEach(card => {
                    card.classList.remove('selected');
                });
                document.getElementById('requestBtn').disabled = true;

                await loadGoals();
                if (isAdmin) {
                    await loadAdminPanel();
                }
            } catch (error) {
                console.error('Error requesting goals:', error);
                alert('Error requesting goals. Please try again.');
            } finally {
                showLoading(false);
            }
        }

        async function loadAdminPanel() {
            try {
                const pendingGoalsSnapshot = await db.collectionGroup('goals')
                    .where('status', '==', 'pending')
                    .get();

                const pendingGoals = pendingGoalsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    userEmail: doc.ref.parent.parent.id,
                    ...doc.data()
                }));

                if (pendingGoals.length > 0) {
                    const adminPanel = document.getElementById('adminPanel');
                    adminPanel.style.display = 'block';
                    adminPanel.innerHTML = `
                        <div class="admin-panel">
                            <h2>üë®‚Äçüíº Admin: Pending Goal Approvals</h2>
                            <div class="pending-requests">
                                ${pendingGoals.map(goal => `
                                    <div class="request-item">
                                        <div class="request-info">
                                            <div class="client-email">${goal.clientName || goal.clientEmail}</div>
                                            <div class="goal-title">${goal.title}</div>
                                            <div style="font-size: 0.85rem; color: #666; margin-top: 0.3rem;">
                                                Requested: ${goal.requestedAt ? new Date(goal.requestedAt.toDate()).toLocaleDateString() : 'Just now'}
                                            </div>
                                        </div>
                                        <div class="request-actions">
                                            <button class="approve-btn" onclick="approveGoal('${goal.userEmail}', '${goal.id}')">
                                                ‚úÖ Approve
                                            </button>
                                            <button class="deny-btn" onclick="denyGoal('${goal.userEmail}', '${goal.id}')">
                                                ‚ùå Deny
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading admin panel:', error);
            }
        }

        async function approveGoal(userEmail, goalId) {
            showLoading(true);
            try {
                await db.collection('users')
                    .doc(userEmail)
                    .collection('goals')
                    .doc(goalId)
                    .update({
                        status: 'approved',
                        approvedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        approvedBy: currentUser.email
                    });

                alert('Goal approved! ‚úÖ');
                await loadGoals();
                await loadAdminPanel();
            } catch (error) {
                console.error('Error approving goal:', error);
                alert('Error approving goal. Please try again.');
            } finally {
                showLoading(false);
            }
        }

        async function denyGoal(userEmail, goalId) {
            showLoading(true);
            try {
                await db.collection('users')
                    .doc(userEmail)
                    .collection('goals')
                    .doc(goalId)
                    .delete();

                alert('Goal request denied and removed. ‚ùå');
                await loadGoals();
                await loadAdminPanel();
            } catch (error) {
                console.error('Error denying goal:', error);
                alert('Error denying goal. Please try again.');
            } finally {
                showLoading(false);
            }
        }

        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.classList.add('active');
            } else {
                overlay.classList.remove('active');
            }
        }

        function signOut() {
            auth.signOut().then(() => {
                window.location.href = 'portal-login.html';
            });
        }
    </script>
</body>
</html>
