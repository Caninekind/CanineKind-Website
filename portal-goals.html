<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Training Goals - CanineKind Client Portal</title>
    <link rel="icon" type="image/x-icon" href="images/favicon.ico">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #D1E5F4 0%, #E8F4F8 100%);
            min-height: 100vh;
            padding-bottom: 40px;
        }

        .portal-header {
            background: linear-gradient(135deg, #799972 0%, #8aaa83 100%);
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .portal-logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .portal-logo img {
            height: 50px;
            width: auto;
        }

        .portal-logo h1 {
            color: white;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .portal-nav {
            display: flex;
            gap: 1.5rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .portal-nav a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s;
            padding: 0.5rem 1rem;
            border-radius: 5px;
        }

        .portal-nav a:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .portal-nav a.active {
            background: rgba(255, 255, 255, 0.3);
            font-weight: 600;
        }

        .sign-out-link {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.85rem;
            padding: 0.4rem 0.8rem;
        }

        .sign-out-link:hover {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.9);
        }

        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .page-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .page-header h1 {
            color: #333;
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .page-header p {
            color: #666;
            font-size: 1.1rem;
        }

        /* Progress Overview */
        .progress-overview {
            background: white;
            border-radius: 10px;
            padding: 2.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-left: 5px solid #799972;
        }

        .progress-overview h2 {
            color: #2c3e50;
            margin-bottom: 1.5rem;
            font-size: 1.4rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .current-level-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .level-name {
            font-size: 1.2rem;
            font-weight: 700;
            color: #799972;
            text-transform: uppercase;
        }

        .level-progress-bar {
            flex: 1;
            margin: 0 2rem;
        }

        .progress-bar-label {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 0.5rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .progress-bar-outer {
            background: #e0e0e0;
            height: 12px;
            border-radius: 6px;
            overflow: hidden;
        }

        .progress-bar-inner {
            background: linear-gradient(90deg, #799972 0%, #8aaa83 100%);
            height: 100%;
            transition: width 0.4s ease;
        }

        .level-completion {
            font-size: 1.5rem;
            font-weight: 800;
            color: #2c3e50;
        }

        /* Level Section */
        .level-section {
            margin-bottom: 3rem;
        }

        .level-container {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 6px 25px rgba(0,0,0,0.12);
            border: 3px solid #e0e0e0;
            transition: all 0.3s ease;
        }

        .level-container:hover {
            box-shadow: 0 8px 30px rgba(121, 153, 114, 0.2);
        }

        .level-header {
            background: linear-gradient(135deg, #799972 0%, #8aaa83 100%);
            padding: 2rem 2.5rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            box-shadow: 0 5px 20px rgba(121, 153, 114, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            border-left: 6px solid #6a8862;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .level-header:hover {
            box-shadow: 0 6px 25px rgba(121, 153, 114, 0.4);
        }

        .level-collapse-icon {
            font-size: 1.5rem;
            color: white;
            transition: transform 0.3s ease;
            margin-left: 1rem;
        }

        .level-content {
            max-height: 5000px;
            overflow: hidden;
            transition: max-height 0.4s ease, opacity 0.3s ease;
            opacity: 1;
        }

        .level-content.collapsed {
            max-height: 0;
            opacity: 0;
        }

        .level-header.locked {
            background: linear-gradient(135deg, #9e9e9e 0%, #bdbdbd 100%);
            opacity: 0.7;
            border-left-color: #757575;
        }

        .level-title {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .level-badge {
            background: white;
            color: #799972;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            font-weight: 800;
            font-size: 1.2rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.15);
        }

        .level-badge.locked {
            background: white;
            color: #9e9e9e;
        }

        .level-header h2 {
            color: white;
            font-size: 2rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .lock-icon {
            font-size: 2rem;
            color: white;
        }

        .unlock-message {
            background: #fff3cd;
            color: #856404;
            padding: 0.75rem 1.25rem;
            border-radius: 10px;
            font-weight: 500;
        }

        /* Goals Grid */
        .goals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
        }

        .goal-card {
            background: white;
            border-radius: 8px;
            padding: 2rem 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.2s;
            border: 2px solid #e0e0e0;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .goal-card:hover {
            border-color: #799972;
            box-shadow: 0 4px 12px rgba(121, 153, 114, 0.15);
        }

        .goal-card.selected {
            border-color: #799972;
            background: #f8fdf8;
            box-shadow: 0 4px 12px rgba(121, 153, 114, 0.2);
        }

        .goal-card.locked {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .goal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .select-badge {
            background: #799972;
            color: white;
            padding: 0.4rem 1rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: none;
        }

        .goal-card.selected .select-badge {
            display: block;
        }

        .goal-toggle-btn {
            width: 100%;
            padding: 0.75rem 1.5rem;
            background: #799972;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.95rem;
            font-weight: 600;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: auto;
        }

        .goal-toggle-btn:hover {
            background: #6a8862;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(121, 153, 114, 0.4);
        }

        .goal-toggle-btn.remove {
            background: #dc3545;
        }

        .goal-toggle-btn.remove:hover {
            background: #c82333;
        }

        .goal-toggle-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .required-goal-badge {
            width: 100%;
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #7a5c1e;
            border: 2px solid #c9a336;
            border-radius: 6px;
            font-size: 0.95rem;
            font-weight: 700;
            text-transform: uppercase;
            text-align: center;
            margin-top: auto;
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
        }

        .required-goal-badge span {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .goal-card h3 {
            font-size: 1.3rem;
            color: #2c3e50;
            margin-bottom: 0.8rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-align: center;
        }

        .goal-card p {
            color: #555;
            font-size: 0.9rem;
            line-height: 1.6;
            margin-bottom: 1rem;
            text-align: center;
        }

        .goal-card ul {
            list-style: none;
            padding: 0;
            margin: 0;
            color: #555;
            font-size: 0.9rem;
            line-height: 1.8;
        }

        .goal-card ul li {
            padding-left: 1.5rem;
            position: relative;
        }

        .goal-card ul li:before {
            content: "•";
            position: absolute;
            left: 0.5rem;
            color: #799972;
            font-weight: bold;
        }

        .goal-progress {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 2px solid #e0e0e0;
        }

        .progress-bar-container {
            background: #e0e0e0;
            height: 8px;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .progress-bar-fill {
            background: linear-gradient(135deg, #799972 0%, #8aaa83 100%);
            height: 100%;
            transition: width 0.3s;
            border-radius: 10px;
        }

        .progress-text {
            font-size: 0.85rem;
            color: #666;
            font-weight: 500;
        }

        /* Milestone Dropdown */
        .milestone-dropdown {
            margin-top: 1rem;
            border-top: 2px solid #e0e0e0;
            padding-top: 1rem;
        }

        .milestone-dropdown-header {
            cursor: pointer;
            padding: 0.75rem 1rem;
            background: #f8f9fa;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 700;
            color: #2c3e50;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
            transition: all 0.2s;
        }

        .milestone-dropdown-header:hover {
            background: #e9ecef;
        }

        .dropdown-arrow {
            transition: transform 0.3s;
            font-size: 0.9rem;
        }

        .milestone-dropdown.open .dropdown-arrow {
            transform: rotate(180deg);
        }

        .milestone-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .milestone-dropdown.open .milestone-content {
            max-height: 1000px;
            margin-top: 1rem;
        }

        .milestone-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .milestone-item {
            background: #f8f9fa;
            padding: 1.25rem;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .milestone-item:hover {
            background: #e8f5e9;
            border-color: #799972;
        }

        .milestone-item.completed {
            background: #e8f5e9;
            border-color: #799972;
        }

        .milestone-checkbox {
            width: 24px;
            height: 24px;
            cursor: pointer;
            accent-color: #799972;
        }

        .milestone-description {
            flex: 1;
            font-size: 1.05rem;
            color: #333;
        }

        .milestone-item.completed .milestone-description {
            text-decoration: line-through;
            opacity: 0.7;
        }

        .milestone-date {
            font-size: 0.85rem;
            color: #999;
        }

        .coming-soon {
            text-align: center;
            padding: 3rem 2rem;
            color: #999;
            font-size: 1.1rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Congratulations Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .congrats-modal {
            background: white;
            border-radius: 12px;
            padding: 3rem 2.5rem;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .congrats-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .congrats-modal h2 {
            color: #799972;
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 1rem;
            text-transform: uppercase;
        }

        .congrats-modal p {
            color: #555;
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 2rem;
        }

        .modal-btn {
            padding: 1rem 2.5rem;
            background: #799972;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s;
        }

        .modal-btn:hover {
            background: #6a8862;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(121, 153, 114, 0.4);
        }

        .modal-btn.secondary {
            background: #6c757d;
            margin-right: 1rem;
        }

        .modal-btn.secondary:hover {
            background: #5a6268;
        }

        /* Date Entry Modal */
        .date-modal {
            background: white;
            border-radius: 12px;
            padding: 2.5rem 2rem;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        .date-modal h3 {
            color: #2c3e50;
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .date-input-group {
            margin-bottom: 1.5rem;
        }

        .date-input-group label {
            display: block;
            color: #555;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .date-input-group input[type="date"] {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        .date-input-group input[type="date"]:focus {
            outline: none;
            border-color: #799972;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
        }

        /* Notes Modal */
        .notes-modal {
            background: white;
            border-radius: 12px;
            padding: 2.5rem 2rem;
            max-width: 550px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        .notes-modal h3 {
            color: #2c3e50;
            font-size: 1.5rem;
            margin-bottom: 1rem;
            text-align: center;
        }

        .notes-modal p {
            color: #666;
            margin-bottom: 1.5rem;
            text-align: center;
            font-size: 0.95rem;
        }

        .notes-input-group {
            margin-bottom: 1.5rem;
        }

        .notes-input-group label {
            display: block;
            color: #555;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .notes-input-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1rem;
            font-family: inherit;
            min-height: 120px;
            resize: vertical;
            transition: border-color 0.3s;
        }

        .notes-input-group textarea:focus {
            outline: none;
            border-color: #799972;
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .loading-overlay.active {
            display: flex;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #799972;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Training Reminders Styles */
        .reminder-level-group {
            margin-bottom: 1.5rem;
        }

        .reminder-level-header {
            background: linear-gradient(135deg, #799972 0%, #8aaa83 100%);
            color: white;
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            font-weight: 700;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 1rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .reminder-level-header:hover {
            box-shadow: 0 4px 12px rgba(121, 153, 114, 0.3);
        }

        .reminder-collapse-icon {
            font-size: 0.9rem;
            transition: transform 0.3s ease;
        }

        .reminder-level-group.collapsed .reminder-collapse-icon {
            transform: rotate(-90deg);
        }

        .reminder-level-content {
            max-height: 5000px;
            overflow: hidden;
            transition: max-height 0.4s ease, opacity 0.3s ease;
            opacity: 1;
        }

        .reminder-level-group.collapsed .reminder-level-content {
            max-height: 0;
            opacity: 0;
        }

        .reminder-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-left: 4px solid #799972;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }

        .reminder-card:hover {
            box-shadow: 0 4px 12px rgba(121, 153, 114, 0.15);
            transform: translateX(4px);
        }

        .reminder-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            cursor: pointer;
        }

        .reminder-card h3 {
            color: #2c3e50;
            font-size: 1.2rem;
            font-weight: 700;
            margin: 0;
        }

        .reminder-card-icon {
            font-size: 0.9rem;
            color: #799972;
            transition: transform 0.3s ease;
        }

        .reminder-card.collapsed .reminder-card-icon {
            transform: rotate(-90deg);
        }

        .reminder-card-content {
            max-height: 2000px;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            opacity: 1;
        }

        .reminder-card.collapsed .reminder-card-content {
            max-height: 0;
            opacity: 0;
        }

        .reminder-info {
            display: flex;
            gap: 1rem;
            margin: 1rem 0;
            flex-wrap: wrap;
        }

        .reminder-detail {
            background: #fef3c7;
            padding: 0.6rem 1rem;
            border-radius: 6px;
            border-left: 3px solid #f59e0b;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .reminder-detail strong {
            color: #92400e;
            font-size: 0.85rem;
            font-weight: 700;
        }

        .reminder-detail span {
            color: #451a03;
            font-size: 0.95rem;
            font-weight: 600;
        }

        .prep-instructions {
            background: #f8f9fa;
            border-left: 3px solid #799972;
            border-radius: 6px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .prep-instructions strong {
            display: block;
            color: #2c3e50;
            font-size: 0.9rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .prep-instructions p {
            color: #555;
            line-height: 1.5;
            margin: 0;
            font-size: 0.95rem;
        }

        .personal-note-section {
            background: #e8f4f8;
            border-left: 3px solid #4facfe;
            border-radius: 6px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .personal-note-section strong {
            color: #2c3e50;
            font-size: 0.95rem;
            font-weight: 700;
        }

        .personal-note-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #d1e8f7;
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.95rem;
            line-height: 1.5;
            color: #333;
            background: white;
            resize: vertical;
            transition: all 0.3s ease;
        }

        .personal-note-input:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .personal-note-input::placeholder {
            color: #999;
            font-style: italic;
        }

        .save-status {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .no-reminders {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .no-reminders p:first-child {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .no-reminders a {
            color: #799972;
            font-weight: 600;
            text-decoration: none;
        }

        .no-reminders a:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .portal-nav {
                gap: 0.5rem;
                font-size: 0.9rem;
                justify-content: center;
                flex-wrap: wrap;
            }

            .portal-nav a {
                padding: 0.4rem 0.8rem;
                font-size: 0.85rem;
            }

            .sign-out-link {
                font-size: 0.75rem;
                padding: 0.3rem 0.6rem;
                opacity: 0.6;
                margin-left: 1rem;
            }

            .page-header h1 {
                font-size: 2rem;
            }

            .goals-grid {
                grid-template-columns: 1fr;
            }

            .progress-stats {
                grid-template-columns: 1fr;
            }

            .container {
                padding: 0 1rem;
            }

            .progress-overview {
                padding: 1.5rem 1rem;
            }

            .current-level-info {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }

            .level-name {
                font-size: 1rem;
                text-align: center;
            }

            .level-progress-bar {
                margin: 0;
                width: 100%;
            }

            .level-completion {
                text-align: center;
                font-size: 1.3rem;
            }

            .level-header {
                padding: 1rem 1.5rem;
            }

            .level-header h2 {
                font-size: 1.3rem;
            }

            .level-badge {
                font-size: 0.9rem;
                padding: 0.4rem 0.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <header class="portal-header">
        <div class="header-content">
            <div class="portal-logo">
                <img src="https://i.imgur.com/OXiQWa3.jpeg" alt="CanineKind Logo">
                <h1>Client Portal</h1>
            </div>
            <nav class="portal-nav">
                <a href="portal-dashboard.html">Dashboard</a>
                <a href="portal-sessions.html">Sessions</a>
                <a href="portal-forms.html">Forms & Documents</a>
                <a href="portal-schedule.html">Weekly Schedule</a>
                <a href="portal-goals.html" class="active">Goals</a>
                <a href="portal-admin-dashboard.html" id="adminPortalLink" style="display: none; background-color: #4A90A4;">Admin Portal</a>
                <a href="#" class="sign-out-link" onclick="signOut(); return false;">Sign Out</a>
            </nav>
        </div>
    </header>

    <div class="container">
        <div class="page-header">
            <h1>Training Goals</h1>
            <p>Select goals and track your dog's training progress through each level</p>
        </div>

        <!-- Progress Overview -->
        <div class="progress-overview">
            <h2>Training Progress</h2>
            <div class="current-level-info">
                <div class="level-name" id="currentLevelName">Level 0: Get Ready to Train!</div>
                <div class="level-progress-bar">
                    <div class="progress-bar-label">Level Completion</div>
                    <div class="progress-bar-outer">
                        <div class="progress-bar-inner" id="levelProgressBar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="level-completion" id="levelCompletionPercent">0%</div>
            </div>

            <!-- Training Reminders Section -->
            <div id="trainingRemindersSection" style="display: none; margin-top: 2rem; padding-top: 2rem; border-top: 2px solid #e0e0e0;">
                <h2 style="color: #2c3e50; font-size: 1.4rem; font-weight: 700; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 1px;">You have plans to work on your training goals!</h2>
                <p style="color: #666; font-size: 1rem; margin-bottom: 1.5rem;">Here's your at-home plan for the week</p>
                <div id="reminderCards"></div>
            </div>
        </div>

        <!-- Levels Container -->
        <div id="levelsContainer"></div>
    </div>

    <!-- Congratulations Modal -->
    <div class="modal-overlay" id="congratsModal">
        <div class="congrats-modal">
            <div class="congrats-icon">★</div>
            <h2>Congratulations!</h2>
            <p id="congratsMessage">You've completed all goals in this level! Your completion has been sent to your trainer for approval.</p>
            <button class="modal-btn" onclick="closeCongratsModal()">Continue Training</button>
        </div>
    </div>

    <!-- Date Entry Modal -->
    <div class="modal-overlay" id="dateModal">
        <div class="date-modal">
            <h3>Milestone Completed!</h3>
            <div class="date-input-group">
                <label for="completionDate">When was this milestone completed?</label>
                <input type="date" id="completionDate" max="">
            </div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeDateModal()">Cancel</button>
                <button class="modal-btn" onclick="saveMilestoneDate()">Save</button>
            </div>
        </div>
    </div>

    <!-- Client Notes Modal -->
    <div class="modal-overlay" id="notesModal">
        <div class="notes-modal">
            <h3>Goal Completed!</h3>
            <p>Before submitting for trainer review, would you like to add any notes or comments?</p>
            <div class="notes-input-group">
                <label for="clientNotes">Notes for your trainer (optional)</label>
                <textarea id="clientNotes" placeholder="Share any challenges, successes, or questions about this goal..."></textarea>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="skipNotes()">Skip</button>
                <button class="modal-btn" onclick="submitWithNotes()">Submit for Review</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- Firebase Config -->
    <script src="firebase-config.js"></script>
    <script>
        let currentUser = null;
        let userAccess = { levels: [], individualGoals: [] };
        let selectedGoals = {};
        let currentLevel = 0;
        let pendingMilestone = null; // Track milestone being edited
        let completedGoalData = null; // Track goal completion for notes

        // Define all goals with their levels and tasks
        const GOALS_STRUCTURE = {
            0: [
                {
                    id: 'training-gear',
                    title: 'Training Gear Checklist',
                    description: `Make sure you have the following training gear for your first in-person session:

• Flat collar or martingale collar
• 6-foot leash (non-retractable)
• High-value treats (small, soft pieces)
• Treat pouch or bag
• Long line (15-30 feet)
• Poop bags
• Water bowl and water
• Any medications your dog needs
• Copy of vaccination records`,
                    type: 'single',
                    tasks: ['Yes I have all my things']
                },
                {
                    id: 'legal-forms',
                    title: 'Sign Legal/Training Forms',
                    description: 'Complete all required legal and training documentation',
                    type: 'single',
                    tasks: ['Forms completed and signed']
                },
                {
                    id: 'review-instructions',
                    title: 'Review Email Instructions',
                    description: 'Review email instructions and guidance prior to meeting with your trainer to ensure your dog is set-up for success!',
                    type: 'single',
                    tasks: ['Yes I have checked my email 24-48 hours before my first session and have reviewed my trainers instructions for success!']
                }
            ],
            1: [
                {
                    id: 'crate-manners-1',
                    title: 'Crate Manners',
                    description: 'Develop good crate behavior and manners',
                    type: 'tasks',
                    tasks: [
                        'Dog enters crate willingly on command',
                        'Dog remains calm and quiet in crate for 10 minutes',
                        'Dog shows no whining or barking in crate'
                    ]
                },
                {
                    id: 'boundaries-thresholds-1',
                    title: 'Boundaries & Thresholds',
                    description: 'Teach your dog to respect boundaries and wait at thresholds',
                    type: 'tasks',
                    tasks: [
                        'Dog waits at front door',
                        'Dog waits at gates and thresholds',
                        'Dog waits for release command before crossing'
                    ]
                },
                {
                    id: 'sit-1',
                    title: 'Sit',
                    description: 'Master the fundamental sit command',
                    type: 'tasks',
                    tasks: [
                        'Dog can sit on command with hand signal',
                        'Dog can sit for 10 seconds before release',
                        'Dog can sit with mild distractions present'
                    ]
                },
                {
                    id: 'down-1',
                    title: 'Down',
                    description: 'Teach your dog to lie down on command',
                    type: 'tasks',
                    tasks: [
                        'Dog can lie down on command with hand signal',
                        'Dog can hold down position for 10 seconds',
                        'Dog can lie down from a sitting or standing position'
                    ]
                },
                {
                    id: 'markers-release-1',
                    title: 'Markers & Release',
                    description: 'Establish clear communication markers and release cues',
                    type: 'tasks',
                    tasks: [
                        'Dog understands "Yes" marker for correct behavior',
                        'Dog responds to "Break" release word',
                        'Dog waits for release word before breaking position'
                    ]
                },
                {
                    id: 'leave-it-1',
                    title: 'Leave It',
                    description: 'Train your dog to ignore or leave objects on command',
                    type: 'tasks',
                    tasks: [
                        'Dog can leave a treat in your hand on command',
                        'Dog can leave a treat on the floor on command',
                        'Dog can walk past distractions without engaging'
                    ]
                },
                {
                    id: 'place-1',
                    title: 'Place',
                    description: 'Teach your dog to go to their designated spot',
                    type: 'tasks',
                    tasks: [
                        'Dog goes to place on command',
                        'Dog stays on place for 30 seconds',
                        'Dog can hold place with mild distractions'
                    ]
                }
            ],
            2: [
                {
                    id: 'crate-manners-2',
                    title: 'Crate Manners',
                    description: 'Extended crate training with more distractions',
                    type: 'tasks',
                    tasks: [
                        'Dog remains calm in crate for 30 minutes',
                        'Dog shows no reactivity to household movement',
                        'Dog settles quickly when crated'
                    ]
                },
                {
                    id: 'boundaries-thresholds-2',
                    title: 'Boundaries & Thresholds',
                    description: 'Wait at all doorways with distractions present',
                    type: 'tasks',
                    tasks: [
                        'Dog waits at all doors consistently',
                        'Dog waits with people passing by',
                        'Dog holds position until released'
                    ]
                },
                {
                    id: 'sit-2',
                    title: 'Sit',
                    description: 'Reliable sit with moderate distractions',
                    type: 'tasks',
                    tasks: [
                        'Dog sits with moderate distractions present',
                        'Dog sits from a distance of 10 feet',
                        'Dog holds sit for 30 seconds'
                    ]
                },
                {
                    id: 'down-2',
                    title: 'Down',
                    description: 'Reliable down with moderate distractions',
                    type: 'tasks',
                    tasks: [
                        'Dog downs with moderate distractions present',
                        'Dog downs from a distance of 10 feet',
                        'Dog holds down for 30 seconds'
                    ]
                },
                {
                    id: 'markers-release-2',
                    title: 'Markers & Release',
                    description: 'Advanced marker understanding in various environments',
                    type: 'tasks',
                    tasks: [
                        'Dog responds to multiple markers in sequence',
                        'Dog maintains position until release',
                        'Dog generalizes markers to different environments'
                    ]
                },
                {
                    id: 'leave-it-2',
                    title: 'Leave It',
                    description: 'Advanced leave it command with higher distractions',
                    type: 'tasks',
                    tasks: [
                        'Dog leaves food on ground while walking',
                        'Dog leaves people or dogs approaching',
                        'Dog responds to leave it at a distance'
                    ]
                },
                {
                    id: 'place-2',
                    title: 'Place',
                    description: 'Extended place command with more duration',
                    type: 'tasks',
                    tasks: [
                        'Dog holds place for 2 minutes',
                        'Dog holds place with household distractions',
                        'Dog goes to place from a distance'
                    ]
                },
                {
                    id: 'toy-ball-out-2',
                    title: 'Toy-Ball Out',
                    description: 'Drop and release toys on command',
                    type: 'tasks',
                    tasks: [
                        'Dog drops toy in handler\'s hand',
                        'Dog releases ball on "out" command',
                        'Dog releases without hesitation'
                    ]
                }
            ],
            3: [
                {
                    id: 'crate-manners-3',
                    title: 'Crate Manners',
                    description: 'Master level crate behavior in all situations',
                    type: 'tasks',
                    tasks: [
                        'Dog remains calm in crate for 1+ hour',
                        'Dog settles immediately when crated',
                        'Dog shows no reactivity to any distractions'
                    ]
                },
                {
                    id: 'boundaries-thresholds-3',
                    title: 'Boundaries & Thresholds',
                    description: 'Automatic wait at all boundaries without command',
                    type: 'tasks',
                    tasks: [
                        'Dog automatically sits at all thresholds',
                        'Dog waits with high distractions',
                        'Dog generalizes behavior to new locations'
                    ]
                },
                {
                    id: 'sit-3',
                    title: 'Sit',
                    description: 'Master sit under all conditions and high distractions',
                    type: 'tasks',
                    tasks: [
                        'Dog sits with high distractions present',
                        'Dog sits from distance of 20+ feet',
                        'Dog holds sit for 1+ minute'
                    ]
                },
                {
                    id: 'down-3',
                    title: 'Down',
                    description: 'Master down under all conditions and high distractions',
                    type: 'tasks',
                    tasks: [
                        'Dog downs with high distractions present',
                        'Dog downs from distance of 20+ feet',
                        'Dog holds down for 1+ minute'
                    ]
                },
                {
                    id: 'markers-release-3',
                    title: 'Markers & Release',
                    description: 'Master marker system in all environments',
                    type: 'tasks',
                    tasks: [
                        'Dog responds to complex marker sequences',
                        'Dog performs multiple behaviors before release',
                        'Dog works reliably in all environments'
                    ]
                },
                {
                    id: 'leave-it-3',
                    title: 'Leave It',
                    description: 'Master level leave it with high-value items',
                    type: 'tasks',
                    tasks: [
                        'Dog leaves high-value items on command',
                        'Dog responds to leave it off-leash',
                        'Dog shows automatic leave it behavior'
                    ]
                },
                {
                    id: 'place-3',
                    title: 'Place',
                    description: 'Master place command in public settings',
                    type: 'tasks',
                    tasks: [
                        'Dog holds place for 5+ minutes',
                        'Dog goes to place in public settings',
                        'Dog responds to remote send to place'
                    ]
                },
                {
                    id: 'toy-ball-out-3',
                    title: 'Toy-Ball Out',
                    description: 'Immediate release of any item on command',
                    type: 'tasks',
                    tasks: [
                        'Dog releases high-value items',
                        'Dog releases during play excitement',
                        'Dog releases items at distance'
                    ]
                }
            ],
            4: [
                {
                    id: 'crate-manners-4',
                    title: 'Crate Manners',
                    description: 'Expert crate behavior in all situations',
                    type: 'tasks',
                    tasks: [
                        'Dog remains calm for extended duration (2+ hours)',
                        'Dog is calm in unfamiliar crates',
                        'Dog demonstrates competition-level crate manners'
                    ]
                },
                {
                    id: 'boundaries-thresholds-4',
                    title: 'Boundaries & Thresholds',
                    description: 'Perfect threshold control in all scenarios',
                    type: 'tasks',
                    tasks: [
                        'Dog automatically waits in all scenarios',
                        'Dog waits with extreme distractions',
                        'Dog maintains behavior in novel environments'
                    ]
                },
                {
                    id: 'sit-4',
                    title: 'Sit',
                    description: 'Competition level sit command',
                    type: 'tasks',
                    tasks: [
                        'Dog responds with immediate sit',
                        'Dog sits from distance of 50+ feet',
                        'Dog holds sit for 2+ minutes'
                    ]
                },
                {
                    id: 'down-4',
                    title: 'Down',
                    description: 'Competition level down command',
                    type: 'tasks',
                    tasks: [
                        'Dog responds with immediate down',
                        'Dog downs from distance of 50+ feet',
                        'Dog holds down for 2+ minutes'
                    ]
                },
                {
                    id: 'markers-release-4',
                    title: 'Markers & Release',
                    description: 'Expert marker system for competition',
                    type: 'tasks',
                    tasks: [
                        'Dog shows perfect timing recognition',
                        'Dog chains multiple behaviors together',
                        'Dog works in competition settings'
                    ]
                },
                {
                    id: 'leave-it-4',
                    title: 'Leave It',
                    description: 'Expert leave it command in all scenarios',
                    type: 'tasks',
                    tasks: [
                        'Dog leaves items in extreme scenarios',
                        'Dog shows generalized automatic leave it',
                        'Dog demonstrates competition-level reliability'
                    ]
                },
                {
                    id: 'place-4',
                    title: 'Place',
                    description: 'Expert place command for competition',
                    type: 'tasks',
                    tasks: [
                        'Dog holds place for 10+ minutes',
                        'Dog goes to place in competition settings',
                        'Dog responds to multiple place positions'
                    ]
                },
                {
                    id: 'toy-ball-out-4',
                    title: 'Toy-Ball Out',
                    description: 'Expert release command in all scenarios',
                    type: 'tasks',
                    tasks: [
                        'Dog shows instant out response',
                        'Dog releases in any scenario',
                        'Dog demonstrates competition-level reliability'
                    ]
                },
                {
                    id: 'long-distance-4',
                    title: 'Long Distance Commands',
                    description: 'Commands at extreme distances',
                    type: 'tasks',
                    tasks: [
                        'Dog responds to commands at 100+ feet',
                        'Dog responds to visual signals only',
                        'Dog is reliable in all environments'
                    ]
                }
            ],
            5: [
                {
                    id: 'dog-neutrality-1',
                    title: 'Dog Neutrality Level 1',
                    description: 'Basic calm behavior around other dogs',
                    type: 'tasks',
                    tasks: [
                        'Dog notices other dogs without reacting',
                        'Dog walks past other dogs at 20 feet',
                        'Dog maintains focus on handler'
                    ]
                },
                {
                    id: 'dog-neutrality-2',
                    title: 'Dog Neutrality Level 2',
                    description: 'Improved calm behavior around other dogs',
                    type: 'tasks',
                    tasks: [
                        'Dog walks past other dogs at 10 feet',
                        'Dog holds sit-stay with dogs nearby',
                        'Dog responds to commands near other dogs'
                    ]
                },
                {
                    id: 'dog-neutrality-3',
                    title: 'Dog Neutrality Level 3',
                    description: 'Expert neutrality around other dogs',
                    type: 'tasks',
                    tasks: [
                        'Dog walks past other dogs at 5 feet or less',
                        'Dog ignores off-leash dogs',
                        'Dog maintains neutrality with barking dogs'
                    ]
                }
            ],
            6: [
                {
                    id: 'human-neutrality-1',
                    title: 'Human Neutrality Level 1',
                    description: 'Basic calm behavior around people',
                    type: 'tasks',
                    tasks: [
                        'Dog walks past strangers at 10 feet',
                        'Dog does not jump on people',
                        'Dog maintains loose leash near people'
                    ]
                },
                {
                    id: 'human-neutrality-2',
                    title: 'Human Neutrality Level 2',
                    description: 'Improved calm behavior around people',
                    type: 'tasks',
                    tasks: [
                        'Dog ignores people approaching',
                        'Dog remains calm when people pet or touch',
                        'Dog maintains focus in crowds'
                    ]
                },
                {
                    id: 'human-neutrality-3',
                    title: 'Human Neutrality Level 3',
                    description: 'Expert neutrality around people',
                    type: 'tasks',
                    tasks: [
                        'Dog shows perfect manners with children',
                        'Dog ignores running or playing people',
                        'Dog remains calm in very crowded areas'
                    ]
                }
            ],
            7: [
                {
                    id: 'trigger-neutrality-1',
                    title: 'General Trigger Neutrality Level 1',
                    description: 'Basic desensitization to common triggers',
                    type: 'tasks',
                    tasks: [
                        'Dog remains calm with basic sounds (doorbell, etc)',
                        'Dog ignores moving objects (bikes, skateboards)',
                        'Dog settles during household activity'
                    ]
                },
                {
                    id: 'trigger-neutrality-2',
                    title: 'General Trigger Neutrality Level 2',
                    description: 'Improved trigger management',
                    type: 'tasks',
                    tasks: [
                        'Dog remains calm with loud noises',
                        'Dog ignores fast-moving triggers',
                        'Dog maintains training focus near triggers'
                    ]
                },
                {
                    id: 'trigger-neutrality-3',
                    title: 'General Trigger Neutrality Level 3',
                    description: 'Expert trigger neutrality',
                    type: 'tasks',
                    tasks: [
                        'Dog shows no reaction to any common trigger',
                        'Dog demonstrates generalized neutrality',
                        'Dog shows proactive calming behavior'
                    ]
                }
            ],
            8: [
                {
                    id: 'loose-leash-1',
                    title: 'Loose Leash Walking Level 1',
                    description: 'Foundation leash walking skills',
                    type: 'tasks',
                    tasks: [
                        'Dog walks without pulling for short distances',
                        'Dog responds to direction changes',
                        'Dog checks in with handler during walks'
                    ]
                },
                {
                    id: 'loose-leash-2',
                    title: 'Loose Leash Walking Level 2',
                    description: 'Reliable loose leash walking',
                    type: 'tasks',
                    tasks: [
                        'Dog walks without pulling for medium distances',
                        'Dog maintains loose leash with mild distractions',
                        'Dog shows heel position awareness'
                    ]
                },
                {
                    id: 'loose-leash-3',
                    title: 'Loose Leash Walking Level 3',
                    description: 'Master loose leash walking',
                    type: 'tasks',
                    tasks: [
                        'Dog maintains perfect loose leash in all environments',
                        'Dog holds heel position on command',
                        'Dog shows no pulling with any distractions'
                    ]
                }
            ]
        };

        const LEVEL_DESCRIPTIONS = {
            0: 'Get Ready to Train!',
            1: 'Basic Obedience',
            2: 'Intermediate Obedience',
            3: 'Advanced Obedience',
            4: 'Master Obedience',
            5: 'Dog Neutrality',
            6: 'Human Neutrality',
            7: 'General Trigger Neutrality',
            8: 'Loose Leash Walking'
        };

        // Training Prep Instructions for each goal at each level
        const TRAINING_PREP_INSTRUCTIONS = {
            'sit': {
                1: 'Bring small, soft training treats. Practice in a quiet area with minimal distractions. Keep sessions short (5-10 minutes).',
                2: 'Practice with mild distractions present. Bring high-value treats and work on duration.',
                3: 'Practice in public places with more distractions. Work on sit-stays with distance.',
                4: 'Master level - practice sit command in highly distracting environments and at a distance.'
            },
            'down': {
                1: 'Use a comfortable mat or towel for your dog. Bring soft treats and practice in a quiet space.',
                2: 'Practice down with mild distractions. Work on holding the position longer.',
                3: 'Practice in different locations and with moderate distractions.',
                4: 'Master level - down-stay in public places with high distractions.'
            },
            'recall': {
                1: 'Since we\'re still on level 1, make sure you bring your longline! Use high-value treats and practice in a safe, enclosed area.',
                2: 'Bring your longline for safety. Practice with mild distractions present. Use a special recall word.',
                3: 'Practice recall with moderate distractions. Begin working on distance recalls.',
                4: 'Master level recall - practice in highly distracting environments. Work towards reliable off-leash recall.'
            },
            'markers-release': {
                1: 'Bring a clicker or use a verbal marker ("Yes!"). Have plenty of small treats ready.',
                2: 'Practice clear, consistent markers. Work on timing and precision.',
                3: 'Use markers with more complex behaviors and in distracting environments.',
                4: 'Master level - markers should be second nature. Practice with advanced behaviors.'
            },
            'place': {
                1: 'Bring your dog\'s place mat or bed. Use treats to lure them to the spot. Practice in a quiet area.',
                2: 'Practice "place" with mild distractions. Work on duration and distance.',
                3: 'Use the place command in different locations. Increase distractions.',
                4: 'Master level - your dog should go to place and stay even in highly distracting environments.'
            },
            'crate-manners': {
                1: 'Make the crate comfortable with bedding and safe toys. Bring high-value treats for positive associations.',
                2: 'Practice longer duration crate time. Work on calm entry and exit.',
                3: 'Your dog should be comfortable in the crate for extended periods. Practice in different locations.',
                4: 'Master level - your dog should love their crate and be calm for extended periods.'
            },
            'boundaries-thresholds': {
                1: 'Practice at familiar doorways first. Use treats to reward waiting. Keep sessions short and positive.',
                2: 'Increase duration and practice at different thresholds. Add mild distractions.',
                3: 'Practice boundary respect in public spaces and new environments.',
                4: 'Master level - your dog should automatically wait at all thresholds and boundaries.'
            },
            'leave-it': {
                1: 'Start with low-value items. Use high-value treats as rewards. Practice in a controlled environment.',
                2: 'Increase difficulty with more tempting items. Practice on walks with real-world distractions.',
                3: 'Work on leave-it at a distance and with highly tempting objects.',
                4: 'Master level - your dog should reliably leave anything on command, even off-leash.'
            },
            'basic-engagement': {
                1: 'Bring your dog\'s favorite treats. Practice in a quiet area with minimal distractions. Keep sessions fun and short.',
                2: 'Practice engagement with mild distractions present. Work on increasing duration of focus.',
                3: 'Practice in busier environments. Your dog should check in regularly during walks.',
                4: 'Master level - your dog should be highly engaged and responsive even in distracting environments.'
            }
        };

        // Wait for Firebase to load
        function waitForFirebase() {
            return new Promise((resolve) => {
                if (typeof firebase !== 'undefined') {
                    resolve();
                } else {
                    const checkInterval = setInterval(() => {
                        if (typeof firebase !== 'undefined') {
                            clearInterval(checkInterval);
                            resolve();
                        }
                    }, 100);
                }
            });
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await waitForFirebase();

            const initialized = initializeFirebase();
            if (!initialized) {
                window.location.href = 'portal-login.html';
                return;
            }

            auth.onAuthStateChanged(async (user) => {
                if (!user) {
                    window.location.href = 'portal-login.html';
                } else {
                    const approval = await checkUserApproval(user.uid);
                    if (!approval.approved) {
                        window.location.href = 'portal-pending.html';
                    } else {
                        currentUser = user;
                        await loadUserData();
                        renderLevels();
                    }
                }
            });
        });

        async function loadUserData() {
            showLoading(true);
            try {
                console.log('🔵 Loading user data for:', currentUser.email);

                // Load user document with settings and role
                console.log('🔵 Loading user settings...');
                const userDoc = await db.collection('users')
                    .doc(currentUser.uid)
                    .get();

                if (userDoc.exists) {
                    const userData = userDoc.data();
                    userAccess = userData.settings || {};
                    const isAdmin = userData.role === 'admin';
                    console.log('✅ User settings loaded. Role:', userData.role);

                    // Admins have full access to everything
                    if (isAdmin) {
                        userAccess.accessibleLevels = [0, 1, 2, 3, 4];
                        document.getElementById('adminPortalLink').style.display = 'inline-block';
                        console.log('✅ Admin detected - granting full access');
                    }
                } else {
                    console.log('ℹ️ No user document found - using defaults');
                    userAccess = {};
                }

                // Load goals progress from top-level collection
                console.log('🔵 Loading goals progress...');
                const goalsSnapshot = await db.collection('goalsProgress')
                    .where('userId', '==', currentUser.uid)
                    .get();

                selectedGoals = {};
                goalsSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    selectedGoals[data.goalId] = {
                        id: data.goalId,
                        progressDocId: doc.id, // Store the progress document ID for updates
                        ...data
                    };
                });
                console.log('✅ Loaded', Object.keys(selectedGoals).length, 'goals in progress');

                // Auto-assign Level 0 goals if not already assigned
                await autoAssignLevel0Goals();

                updateLevelProgress();

                // Load training reminders
                await loadTrainingReminders();
            } catch (error) {
                console.error('❌ Error loading user data:', error);
                console.error('❌ Error code:', error.code);
                console.error('❌ Error message:', error.message);

                let errorMsg = 'Error loading goals data:\n\n';
                if (error.code === 'permission-denied') {
                    errorMsg += '🔒 PERMISSION DENIED\n\n';
                    errorMsg += 'This means your Firestore security rules need to be updated.\n\n';
                    errorMsg += 'ACTION REQUIRED:\n';
                    errorMsg += '1. Open Firebase Console\n';
                    errorMsg += '2. Go to Firestore > Rules tab\n';
                    errorMsg += '3. Copy content from FIRESTORE_RULES.txt\n';
                    errorMsg += '4. Paste and click Publish\n\n';
                    errorMsg += 'See COPY_PASTE_INSTRUCTIONS.md for detailed steps.';
                } else {
                    errorMsg += error.message;
                }

                alert(errorMsg);
            } finally {
                showLoading(false);
            }
        }

        // Auto-assign Level 0 goals to all users (required onboarding goals)
        async function autoAssignLevel0Goals() {
            try {
                const level0Goals = GOALS_STRUCTURE[0];
                const batch = db.batch();
                let goalsAdded = 0;

                for (const goal of level0Goals) {
                    // Check if this Level 0 goal is already assigned
                    if (!selectedGoals[goal.id]) {
                        console.log(`Auto-assigning Level 0 goal: ${goal.title}`);

                        // Prepare goal data
                        const goalData = {
                            ...goal,
                            level: 0,
                            selectedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            progress: 0,
                            tasks: goal.tasks.map(task => ({
                                text: task,
                                completed: false
                            }))
                        };

                        // Add to selectedGoals in memory
                        selectedGoals[goal.id] = goalData;

                        // Add to batch for Firestore goalsProgress collection
                        const progressRef = db.collection('goalsProgress').doc();
                        batch.set(progressRef, {
                            userId: currentUser.uid,
                            goalId: goal.id,
                            ...goalData
                        });

                        // Store progress doc ID for future updates
                        selectedGoals[goal.id].progressDocId = progressRef.id;
                        goalsAdded++;
                    }
                }

                // Commit batch if we added any goals
                if (goalsAdded > 0) {
                    await batch.commit();
                    console.log(`✅ Auto-assigned ${goalsAdded} Level 0 goals to user`);

                    // Re-render the levels to show the newly assigned goals
                    renderLevels();
                }
            } catch (error) {
                console.error('Error auto-assigning Level 0 goals:', error);
            }
        }

        function hasAccessToGoal(goalId, level) {
            // Level 0 is always accessible
            if (level === 0) return true;

            // TEMPORARY: Unlock all goals for testing (remove when Firebase functions are implemented)
            return true;

            // Check if user has level access
            if (userAccess.levels && userAccess.levels.includes(level)) {
                return true;
            }
            // Check if user has individual goal access
            if (userAccess.individualGoals && userAccess.individualGoals.includes(goalId)) {
                return true;
            }
            return false;
        }

        function determineCurrentLevel() {
            // Find the first level with selected but incomplete goals
            for (let level = 0; level <= 8; level++) {
                const levelGoals = GOALS_STRUCTURE[level];
                if (!levelGoals || levelGoals.length === 0) continue;

                const selectedInLevel = Object.values(selectedGoals).filter(g => g.level === level);
                if (selectedInLevel.length > 0) {
                    // Check if all are complete
                    const allComplete = selectedInLevel.every(g => g.progress === 100);
                    if (!allComplete) {
                        return level;
                    }
                }
            }
            // Default to Level 0
            return 0;
        }

        function updateLevelProgress() {
            currentLevel = determineCurrentLevel();
            const levelName = document.getElementById('currentLevelName');
            const progressBar = document.getElementById('levelProgressBar');
            const progressPercent = document.getElementById('levelCompletionPercent');

            levelName.textContent = `Level ${currentLevel}: ${LEVEL_DESCRIPTIONS[currentLevel]}`;

            const levelGoals = GOALS_STRUCTURE[currentLevel];
            if (!levelGoals || levelGoals.length === 0) {
                progressBar.style.width = '0%';
                progressPercent.textContent = '0%';
                return;
            }

            const selectedInLevel = Object.values(selectedGoals).filter(g => g.level === currentLevel);
            if (selectedInLevel.length === 0) {
                progressBar.style.width = '0%';
                progressPercent.textContent = '0%';
                return;
            }

            let totalTasks = 0;
            let completedTasks = 0;

            selectedInLevel.forEach(goal => {
                if (goal.tasks) {
                    totalTasks += goal.tasks.length;
                    completedTasks += goal.tasks.filter(t => t.completed).length;
                }
            });

            const progress = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            progressBar.style.width = progress + '%';
            progressPercent.textContent = progress + '%';
        }

        function renderLevels() {
            const container = document.getElementById('levelsContainer');
            let html = '';

            // Render regular levels
            for (let level = 0; level <= 8; level++) {
                const goals = GOALS_STRUCTURE[level];
                const hasLevelAccess = level === 0 || userAccess.levels?.includes(level);
                const isLocked = !hasLevelAccess && !goals.some(g => hasAccessToGoal(g.id, level));
                const isComingSoon = false; // No longer using coming soon

                // For levels 5-8, these are standalone categories without level numbers
                const isStandaloneCategory = level >= 5;

                html += `
                    <div class="level-section">
                        <div class="level-container">
                            <div class="level-header ${isLocked ? 'locked' : ''}" onclick="toggleLevelContainer(${level})">
                                <div class="level-title">
                                    ${isStandaloneCategory ? `
                                        <h2>${LEVEL_DESCRIPTIONS[level]}</h2>
                                    ` : `
                                        <span class="level-badge ${isLocked ? 'locked' : ''}">Level ${level}</span>
                                        <h2>${LEVEL_DESCRIPTIONS[level]}</h2>
                                    `}
                                </div>
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    ${isLocked ? `<div class="lock-icon">🔒</div>` : ''}
                                    <span class="level-collapse-icon" id="collapse-icon-level-${level}">▼</span>
                                </div>
                            </div>
                            <div class="level-content collapsed" id="level-content-${level}">
                                ${isLocked ? `
                                    <div class="unlock-message">
                                        🔒 This ${isStandaloneCategory ? 'category' : 'level'} will be unlocked by your trainer
                                    </div>
                                ` : isComingSoon ? `
                                    <div class="coming-soon">Coming Soon</div>
                                ` : `
                                    <div class="goals-grid">
                                        ${goals.map(goal => renderGoalCard(goal, level)).join('')}
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            }

            // Render custom goals section
            html += `
                <div class="level-section">
                    <div class="level-container">
                        <div class="level-header locked" onclick="toggleLevelContainer('custom-goals')">
                            <div class="level-title">
                                <span class="level-badge locked">CUSTOM</span>
                                <h2>Your Custom Goals with CanineKind</h2>
                            </div>
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <div class="lock-icon">🔒</div>
                                <span class="level-collapse-icon" id="collapse-icon-level-custom-goals">▼</span>
                            </div>
                        </div>
                        <div class="level-content collapsed" id="level-content-custom-goals">
                            <div class="unlock-message">
                                🎯 Your trainer will create personalized goals specifically for you and your dog's unique needs
                            </div>
                            <div class="custom-goals-list" id="customGoalsList"></div>
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = html;
            attachDropdownListeners();
            loadCustomGoals();
        }

        function renderGoalCard(goal, level, isMastery = false) {
            const hasAccess = isMastery ? true : hasAccessToGoal(goal.id, level);
            const isSelected = selectedGoals.hasOwnProperty(goal.id);
            const progress = isSelected ? calculateGoalProgress(goal.id) : 0;

            let cardContent = '';

            // For Level 0 checklist items, show them in the card
            if (goal.type === 'checklist') {
                cardContent = `
                    <h3>${goal.title}</h3>
                    <p>${goal.description}</p>
                    <ul>
                        ${goal.items.map(item => `<li>${item}</li>`).join('')}
                    </ul>
                `;
            } else {
                // Convert newlines to <br> tags for proper formatting
                const formattedDescription = goal.description.replace(/\n/g, '<br>');
                cardContent = `
                    <h3>${goal.title}</h3>
                    <p style="white-space: pre-line;">${goal.description}</p>
                `;
            }

            return `
                <div class="goal-card ${!hasAccess ? 'locked' : ''} ${isSelected ? 'selected' : ''}">
                    <div class="goal-header">
                        <span class="select-badge">Active</span>
                    </div>
                    ${cardContent}
                    ${isSelected && goal.type !== 'checklist' ? `
                        <div class="goal-progress">
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" style="width: ${progress}%"></div>
                            </div>
                            <div class="progress-text">${progress}% Complete</div>
                        </div>
                        <div class="milestone-dropdown" id="dropdown-${goal.id}">
                            <div class="milestone-dropdown-header" onclick="toggleMilestoneDropdown('${goal.id}')">
                                <span>View Milestones</span>
                                <span class="dropdown-arrow">▼</span>
                            </div>
                            <div class="milestone-content">
                                <div class="milestone-list">
                                    ${renderMilestonesForGoal(goal.id, goal)}
                                </div>
                            </div>
                        </div>
                    ` : isSelected && goal.type === 'checklist' ? `
                        <div class="milestone-dropdown open" id="dropdown-${goal.id}">
                            <div class="milestone-content">
                                <div class="milestone-list">
                                    ${renderMilestonesForGoal(goal.id, goal)}
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    ${hasAccess ? `
                        ${level === 0 && isSelected ? `
                            <div class="required-goal-badge">
                                <span>✓ Required Onboarding</span>
                            </div>
                        ` : `
                            <button class="goal-toggle-btn ${isSelected ? 'remove' : ''}"
                                    onclick="toggleGoal('${goal.id}', ${level})">
                                ${isSelected ? 'Remove Goal' : 'Add Goal'}
                            </button>
                        `}
                    ` : ''}
                </div>
            `;
        }

        function renderMilestonesForGoal(goalId, goal) {
            const goalData = selectedGoals[goalId];
            if (!goalData || !goalData.tasks) return '';

            return goalData.tasks.map((task, index) => {
                const isCompleted = task.completed;
                const completedDate = task.completedAt ? new Date(task.completedAt.toDate()).toLocaleDateString() : '';

                return `
                    <div class="milestone-item ${isCompleted ? 'completed' : ''}">
                        <input type="checkbox"
                               class="milestone-checkbox"
                               ${isCompleted ? 'checked' : ''}
                               onchange="toggleMilestone('${goalId}', ${index})">
                        <div class="milestone-description">${task.description}</div>
                        ${isCompleted ? `<div class="milestone-date">${completedDate}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function toggleMilestoneDropdown(goalId) {
            const dropdown = document.getElementById(`dropdown-${goalId}`);
            if (dropdown) {
                dropdown.classList.toggle('open');
            }
        }

        function attachDropdownListeners() {
            // Dropdowns are now handled inline with onclick
        }

        async function toggleGoal(goalId, level) {
            const goal = GOALS_STRUCTURE[level].find(g => g.id === goalId);
            if (!goal) return;

            // Save scroll position before any operations
            const scrollPosition = window.pageYOffset || document.documentElement.scrollTop;

            if (selectedGoals.hasOwnProperty(goalId)) {
                // Check if this is a Level 0 (onboarding) goal - these cannot be removed
                if (level === 0) {
                    alert('This is a required onboarding goal and cannot be removed. Please complete all onboarding tasks before proceeding with other training goals.');
                    return;
                }

                // Deselect goal
                if (confirm('Are you sure you want to remove this goal? Your progress will be saved.')) {
                    try {
                        showLoading(true);
                        const progressDocId = selectedGoals[goalId]?.progressDocId;
                        if (progressDocId) {
                            await db.collection('goalsProgress')
                                .doc(progressDocId)
                                .delete();
                        }

                        delete selectedGoals[goalId];
                        renderLevels();
                        updateLevelProgress();
                        await loadTrainingReminders(); // Refresh reminders when goal removed

                        // Restore scroll position after rendering
                        window.scrollTo(0, scrollPosition);
                    } catch (error) {
                        console.error('Error removing goal:', error);
                        alert('Error removing goal');
                    } finally {
                        showLoading(false);
                    }
                }
            } else {
                // Select goal
                try {
                    showLoading(true);

                    // Prepare tasks based on goal type
                    let tasks = [];
                    if (goal.type === 'checklist' && goal.items) {
                        tasks = goal.items.map(item => ({
                            description: item,
                            completed: false
                        }));
                    } else if (goal.tasks) {
                        tasks = goal.tasks.map(desc => ({
                            description: desc,
                            completed: false
                        }));
                    }

                    const progressRef = db.collection('goalsProgress').doc();
                    await progressRef.set({
                        userId: currentUser.uid,
                        goalId: goalId,
                        level: level,
                        title: goal.title,
                        description: goal.description,
                        type: goal.type,
                        tasks: tasks,
                        selectedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        progress: 0
                    });

                    selectedGoals[goalId] = {
                        id: goalId,
                        progressDocId: progressRef.id,
                        level,
                        title: goal.title,
                        description: goal.description,
                        type: goal.type,
                        tasks,
                        progress: 0
                    };

                    renderLevels();
                    updateLevelProgress();
                    await loadTrainingReminders(); // Refresh reminders when goal added

                    // Restore scroll position after rendering
                    window.scrollTo(0, scrollPosition);
                } catch (error) {
                    console.error('Error selecting goal:', error);
                    alert('Error selecting goal');
                } finally {
                    showLoading(false);
                }
            }
        }

        async function toggleMilestone(goalId, milestoneIndex) {
            if (!selectedGoals[goalId]) return;

            const goalData = selectedGoals[goalId];
            const milestone = goalData.tasks[milestoneIndex];

            // If checking the milestone, show date picker
            if (!milestone.completed) {
                pendingMilestone = { goalId, milestoneIndex };
                showDateModal();
            } else {
                // If unchecking, just uncheck it
                try {
                    milestone.completed = false;
                    milestone.completedAt = null;

                    const progress = calculateGoalProgress(goalId);

                    const progressDocId = selectedGoals[goalId]?.progressDocId;
                    if (progressDocId) {
                        await db.collection('goalsProgress')
                            .doc(progressDocId)
                            .update({
                                tasks: goalData.tasks,
                                progress: progress
                            });
                    }

                    selectedGoals[goalId].progress = progress;
                    renderLevels();
                    updateLevelProgress();
                } catch (error) {
                    console.error('Error toggling milestone:', error);
                    alert('Error updating milestone');
                }
            }
        }

        function showDateModal() {
            const modal = document.getElementById('dateModal');
            const dateInput = document.getElementById('completionDate');

            // Set max date to today
            const today = new Date().toISOString().split('T')[0];
            dateInput.max = today;
            dateInput.value = today;

            modal.classList.add('active');
        }

        function closeDateModal() {
            const modal = document.getElementById('dateModal');
            modal.classList.remove('active');
            pendingMilestone = null;

            // Uncheck the checkbox since they cancelled
            renderLevels();
        }

        async function saveMilestoneDate() {
            if (!pendingMilestone) return;

            const dateInput = document.getElementById('completionDate');
            const selectedDate = dateInput.value;

            if (!selectedDate) {
                alert('Please select a date');
                return;
            }

            try {
                const { goalId, milestoneIndex } = pendingMilestone;
                const goalData = selectedGoals[goalId];
                const milestone = goalData.tasks[milestoneIndex];

                // Convert selected date to Firebase timestamp
                const dateObj = new Date(selectedDate + 'T12:00:00');
                milestone.completed = true;
                milestone.completedAt = firebase.firestore.Timestamp.fromDate(dateObj);

                const progress = calculateGoalProgress(goalId);

                const progressDocId = selectedGoals[goalId]?.progressDocId;
                if (progressDocId) {
                    await db.collection('goalsProgress')
                        .doc(progressDocId)
                        .update({
                            tasks: goalData.tasks,
                            progress: progress
                        });
                }

                selectedGoals[goalId].progress = progress;

                closeDateModal();
                renderLevels();
                updateLevelProgress();

                // Check if level is complete
                await checkLevelCompletion(goalData.level);
            } catch (error) {
                console.error('Error saving milestone date:', error);
                alert('Error updating milestone');
            }
        }

        async function checkLevelCompletion(level) {
            const levelGoals = GOALS_STRUCTURE[level];
            if (!levelGoals || levelGoals.length === 0) return;

            const selectedInLevel = Object.values(selectedGoals).filter(g => g.level === level);

            // Check if all goals in level are selected and completed
            if (selectedInLevel.length !== levelGoals.length) return;

            const allComplete = selectedInLevel.every(g => g.progress === 100);
            if (!allComplete) return;

            // Check if already sent for approval
            const approvalDoc = await db.collection('users')
                .doc(currentUser.uid)
                .collection('levelCompletions')
                .doc(`level-${level}`)
                .get();

            if (approvalDoc.exists && approvalDoc.data().status === 'pending') {
                // Already sent for approval
                return;
            }

            // For Level 1+, show notes modal before submitting
            if (level >= 1) {
                completedGoalData = { level };
                showNotesModal();
            } else {
                // Level 0 - submit directly without notes
                await submitLevelCompletion(level, null);
            }
        }

        function showNotesModal() {
            const modal = document.getElementById('notesModal');
            const notesTextarea = document.getElementById('clientNotes');
            notesTextarea.value = '';
            modal.classList.add('active');
        }

        function closeNotesModal() {
            const modal = document.getElementById('notesModal');
            modal.classList.remove('active');
            completedGoalData = null;
        }

        async function skipNotes() {
            if (!completedGoalData) return;
            await submitLevelCompletion(completedGoalData.level, null);
            closeNotesModal();
        }

        async function submitWithNotes() {
            if (!completedGoalData) return;

            const notesTextarea = document.getElementById('clientNotes');
            const notes = notesTextarea.value.trim();

            await submitLevelCompletion(completedGoalData.level, notes || null);
            closeNotesModal();
        }

        async function submitLevelCompletion(level, clientNotes) {
            try {
                // Send for admin approval
                const completionData = {
                    level: level,
                    levelName: LEVEL_DESCRIPTIONS[level],
                    completedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'pending',
                    clientEmail: currentUser.email,
                    clientName: currentUser.displayName || currentUser.email
                };

                if (clientNotes) {
                    completionData.clientNotes = clientNotes;
                }

                await db.collection('users')
                    .doc(currentUser.uid)
                    .collection('levelCompletions')
                    .doc(`level-${level}`)
                    .set(completionData);

                // Show congratulations modal
                showCongratsModal(level);
            } catch (error) {
                console.error('Error submitting level completion:', error);
                alert('Error submitting for review');
            }
        }

        function showCongratsModal(level) {
            const modal = document.getElementById('congratsModal');
            const message = document.getElementById('congratsMessage');
            message.textContent = `You've completed all goals in ${LEVEL_DESCRIPTIONS[level]}! Your completion has been sent to your trainer for approval.`;
            modal.classList.add('active');
        }

        function closeCongratsModal() {
            const modal = document.getElementById('congratsModal');
            modal.classList.remove('active');
        }

        function calculateGoalProgress(goalId) {
            const goalData = selectedGoals[goalId];
            if (!goalData || !goalData.tasks) return 0;

            const completedTasks = goalData.tasks.filter(t => t.completed).length;
            const totalTasks = goalData.tasks.length;
            return Math.round((completedTasks / totalTasks) * 100);
        }

        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.classList.add('active');
            } else {
                overlay.classList.remove('active');
            }
        }

        function toggleLevelContainer(levelId) {
            const content = document.getElementById(`level-content-${levelId}`);
            const icon = document.getElementById(`collapse-icon-level-${levelId}`);

            if (!content || !icon) return;

            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                icon.textContent = '▼';
            } else {
                content.classList.add('collapsed');
                icon.textContent = '▶';
            }
        }

        // Training Reminders Functions
        async function loadTrainingReminders() {
            try {
                const reminders = [];

                // Load schedule data from Firebase
                const scheduleDoc = await db.collection('schedules')
                    .doc(`${currentUser.uid}-weekly`)
                    .get();

                if (scheduleDoc.exists) {
                    const scheduleData = scheduleDoc.data();

                    // Check each day and time slot for goal pairings
                    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

                    days.forEach(day => {
                        if (scheduleData[day]) {
                            Object.keys(scheduleData[day]).forEach(timeSlot => {
                                const activities = scheduleData[day][timeSlot];

                                if (Array.isArray(activities)) {
                                    activities.forEach(activityData => {
                                        // Check if this activity has paired goals
                                        let goalIds = [];
                                        if (typeof activityData === 'object') {
                                            // New format: goalIds array
                                            if (activityData.goalIds && Array.isArray(activityData.goalIds)) {
                                                goalIds = activityData.goalIds;
                                            }
                                            // Backward compatibility: old goalId string
                                            else if (activityData.goalId) {
                                                goalIds = [activityData.goalId];
                                            }
                                        }

                                        const activityName = typeof activityData === 'object' ? activityData.activity : activityData;
                                        const personalNote = typeof activityData === 'object' ? activityData.personalNote : null;

                                        // Create a reminder for each goal associated with this activity
                                        goalIds.forEach(goalId => {
                                            if (selectedGoals[goalId]) {
                                                const goal = selectedGoals[goalId];
                                                const goalLevel = goal.level;

                                                // Get prep instructions for this goal at this level
                                                const prepInstructions = TRAINING_PREP_INSTRUCTIONS[goalId]?.[goalLevel] ||
                                                                        'Bring treats and be ready to practice!';

                                                reminders.push({
                                                    goalTitle: goal.title,
                                                    goalId: goalId,
                                                    day: day,
                                                    time: timeSlot,
                                                    activity: activityName,
                                                    level: goalLevel,
                                                    prepInstructions: prepInstructions,
                                                    personalNote: personalNote
                                                });
                                            }
                                        });
                                    });
                                }
                            });
                        }
                    });
                }

                // Display reminders if any exist
                if (reminders.length > 0) {
                    displayTrainingReminders(reminders);
                } else {
                    displayNoReminders();
                }
            } catch (error) {
                console.error('Error loading training reminders:', error);
                // Don't show error to user, just hide reminders section
                document.getElementById('trainingRemindersSection').style.display = 'none';
            }
        }

        function displayTrainingReminders(reminders) {
            const section = document.getElementById('trainingRemindersSection');
            const container = document.getElementById('reminderCards');

            // Group reminders by level
            const remindersByLevel = {};
            reminders.forEach(reminder => {
                const levelKey = reminder.level;
                if (!remindersByLevel[levelKey]) {
                    remindersByLevel[levelKey] = [];
                }
                remindersByLevel[levelKey].push(reminder);
            });

            let html = '';

            // Sort levels (0 first, then 1, 2, 3, 4)
            const sortedLevels = Object.keys(remindersByLevel).sort((a, b) => parseInt(a) - parseInt(b));

            sortedLevels.forEach(levelKey => {
                const level = parseInt(levelKey);
                const levelReminders = remindersByLevel[levelKey];
                const levelName = level === 0 ? 'Preparation' : `Level ${level}`;

                html += `
                    <div class="reminder-level-group collapsed" id="reminder-level-${level}">
                        <div class="reminder-level-header" onclick="toggleReminderLevel(${level})">
                            <span>${levelName} (${levelReminders.length} goal${levelReminders.length !== 1 ? 's' : ''})</span>
                            <span class="reminder-collapse-icon">▼</span>
                        </div>
                        <div class="reminder-level-content">
                `;

                levelReminders.forEach((reminder, index) => {
                    const cardId = `reminder-card-${level}-${index}`;
                    const hasPersonalNote = reminder.personalNote && reminder.personalNote.trim() !== '';
                    html += `
                        <div class="reminder-card collapsed" id="${cardId}" data-day="${reminder.day}" data-time="${reminder.time}" data-goal-id="${reminder.goalId}" data-activity="${reminder.activity}">
                            <div class="reminder-card-header" onclick="toggleReminderCard('${cardId}')">
                                <h3>${reminder.goalTitle}</h3>
                                <span class="reminder-card-icon">▼</span>
                            </div>
                            <div class="reminder-card-content">
                                <div class="reminder-info">
                                    <div class="reminder-detail">
                                        <strong>📅 When:</strong>
                                        <span>${reminder.day}, ${reminder.time}</span>
                                    </div>
                                    <div class="reminder-detail">
                                        <strong>📍 Where:</strong>
                                        <span>${reminder.activity}</span>
                                    </div>
                                </div>

                                <div class="prep-instructions">
                                    <strong>✅ How to Prep:</strong>
                                    <p>${reminder.prepInstructions}</p>
                                </div>

                                <div class="personal-note-section">
                                    <div style="margin-bottom: 0.75rem;">
                                        <strong>📝 Add a custom note to yourself:</strong>
                                    </div>
                                    <p style="font-size: 0.85rem; color: #666; margin-bottom: 0.75rem; line-height: 1.4;">
                                        This note will be included in your CanineKind training plan text/email reminders
                                    </p>
                                    <textarea
                                        id="${cardId}-note"
                                        class="personal-note-input"
                                        placeholder="Example: Bring high-value treats, practice in quiet area, keep sessions short..."
                                        rows="3"
                                        data-day="${reminder.day}"
                                        data-time="${reminder.time}"
                                        data-goal-id="${reminder.goalId}"
                                        data-activity="${reminder.activity}"
                                        onblur="savePersonalNote('${cardId}')"
                                    >${hasPersonalNote ? reminder.personalNote : ''}</textarea>
                                    <div id="${cardId}-status" class="save-status" style="display: none; margin-top: 0.5rem; font-size: 0.85rem; color: #799972; font-weight: 600;">
                                        ✓ Saved
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
            section.style.display = 'block';
        }

        function toggleReminderLevel(level) {
            const group = document.getElementById(`reminder-level-${level}`);
            if (group) {
                group.classList.toggle('collapsed');
            }
        }

        function toggleReminderCard(cardId) {
            const card = document.getElementById(cardId);
            if (card) {
                card.classList.toggle('collapsed');
            }
        }

        async function savePersonalNote(cardId) {
            const noteTextarea = document.getElementById(`${cardId}-note`);
            if (!noteTextarea) return;

            const day = noteTextarea.dataset.day;
            const time = noteTextarea.dataset.time;
            const goalId = noteTextarea.dataset.goalId;
            const activity = noteTextarea.dataset.activity;
            const newNote = noteTextarea.value;
            const statusElement = document.getElementById(`${cardId}-status`);

            try {
                // Load current schedule data
                const scheduleDoc = await db.collection('schedules')
                    .doc(`${currentUser.uid}-weekly`)
                    .get();

                if (scheduleDoc.exists) {
                    const scheduleData = scheduleDoc.data();

                    // Find and update the specific activity
                    if (scheduleData[day] && scheduleData[day][time]) {
                        const activities = scheduleData[day][time];

                        for (let i = 0; i < activities.length; i++) {
                            const activityData = activities[i];
                            if (typeof activityData === 'object' && activityData.activity === activity) {
                                // Check if this activity has the goal (support both old and new format)
                                const hasGoal = (activityData.goalIds && activityData.goalIds.includes(goalId)) ||
                                              (activityData.goalId === goalId);

                                if (hasGoal) {
                                    // Update or remove the personal note
                                    // Note: Personal note is shared across all goals for this activity
                                    if (newNote.trim() !== '') {
                                        activityData.personalNote = newNote.trim();
                                    } else {
                                        delete activityData.personalNote;
                                    }
                                    break;
                                }
                            }
                        }

                        // Save updated schedule data
                        await db.collection('schedules')
                            .doc(`${currentUser.uid}-weekly`)
                            .set({
                                userId: currentUser.uid,
                                ...scheduleData
                            });

                        // Show save confirmation
                        if (statusElement) {
                            statusElement.style.display = 'block';
                            setTimeout(() => {
                                statusElement.style.display = 'none';
                            }, 2000);
                        }
                    }
                }
            } catch (error) {
                console.error('Error saving personal note:', error);
                alert('Error saving personal note. Please try again.');
            }
        }

        function displayNoReminders() {
            const section = document.getElementById('trainingRemindersSection');
            const container = document.getElementById('reminderCards');

            container.innerHTML = `
                <div class="no-reminders">
                    <p>📅 No upcoming training sessions</p>
                    <p>Pair your goals with activities on the <a href="portal-schedule.html">schedule page</a> to see training reminders here!</p>
                </div>
            `;

            section.style.display = 'block';
        }

        // Mock data function for testing (when no real schedule data exists)
        function getMockReminders() {
            return [
                {
                    goalTitle: "Recall",
                    goalId: "recall",
                    day: "Monday",
                    time: "09:00 AM",
                    activity: "Forest Hike",
                    level: 1,
                    prepInstructions: "Since we're still on level 1, make sure you bring your longline! Use high-value treats and practice in a safe, enclosed area."
                },
                {
                    goalTitle: "Sit",
                    goalId: "sit",
                    day: "Wednesday",
                    time: "02:00 PM",
                    activity: "Park Walk",
                    level: 1,
                    prepInstructions: "Bring small, soft training treats. Practice in a quiet area with minimal distractions. Keep sessions short (5-10 minutes)."
                }
            ];
        }

        async function loadCustomGoals() {
            if (!currentUser) return;

            try {
                const customGoalsSnapshot = await db.collection('users')
                    .doc(currentUser.uid)
                    .collection('customGoals')
                    .orderBy('createdAt', 'desc')
                    .get();

                const customGoalsList = document.getElementById('customGoalsList');
                if (!customGoalsList) return;

                if (customGoalsSnapshot.empty) {
                    customGoalsList.innerHTML = '';
                    return;
                }

                let html = '<div class="goals-grid" style="margin-top: 1rem;">';
                customGoalsSnapshot.docs.forEach(doc => {
                    const goal = { id: doc.id, ...doc.data() };
                    const progress = calculateCustomGoalProgress(goal);

                    html += `
                        <div class="goal-card selected">
                            <div class="goal-header">
                                <span class="select-badge">Custom</span>
                            </div>
                            <h3>${goal.title}</h3>
                            <p>${goal.description || ''}</p>
                            <div class="goal-progress">
                                <div class="progress-bar-container">
                                    <div class="progress-bar-fill" style="width: ${progress}%"></div>
                                </div>
                                <div class="progress-text">${progress}% Complete</div>
                            </div>
                            <div class="milestone-dropdown" id="dropdown-custom-${goal.id}">
                                <div class="milestone-dropdown-header" onclick="toggleCustomMilestoneDropdown('${goal.id}')">
                                    <span>View Milestones</span>
                                    <span class="dropdown-arrow">▼</span>
                                </div>
                                <div class="milestone-content">
                                    <div class="milestone-list">
                                        ${renderCustomMilestones(goal)}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';

                customGoalsList.innerHTML = html;

                // Unlock the custom goals section if there are goals
                const customGoalsHeader = document.querySelector('[onclick="toggleLevelContainer(\'custom-goals\')"]');
                if (customGoalsHeader && customGoalsSnapshot.size > 0) {
                    customGoalsHeader.classList.remove('locked');
                    const lockIcon = customGoalsHeader.querySelector('.lock-icon');
                    if (lockIcon) lockIcon.remove();
                    const badge = customGoalsHeader.querySelector('.level-badge');
                    if (badge) badge.classList.remove('locked');
                    const unlockMsg = document.querySelector('#level-content-custom-goals .unlock-message');
                    if (unlockMsg) unlockMsg.style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading custom goals:', error);
            }
        }

        function calculateCustomGoalProgress(goal) {
            if (!goal.tasks || goal.tasks.length === 0) return 0;
            const completed = goal.tasks.filter(t => t.completed).length;
            return Math.round((completed / goal.tasks.length) * 100);
        }

        function renderCustomMilestones(goal) {
            if (!goal.tasks || goal.tasks.length === 0) return '<p>No milestones defined</p>';

            return goal.tasks.map((task, index) => {
                const isCompleted = task.completed;
                const completedDate = task.completedAt ? new Date(task.completedAt.toDate()).toLocaleDateString() : '';

                return `
                    <div class="milestone-item ${isCompleted ? 'completed' : ''}">
                        <input type="checkbox"
                               class="milestone-checkbox"
                               ${isCompleted ? 'checked' : ''}
                               onchange="toggleCustomMilestone('${goal.id}', ${index})">
                        <div class="milestone-description">${task.text}</div>
                        ${isCompleted ? `<div class="milestone-date">${completedDate}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function toggleCustomMilestoneDropdown(goalId) {
            const dropdown = document.getElementById(`dropdown-custom-${goalId}`);
            if (dropdown) {
                dropdown.classList.toggle('open');
            }
        }

        async function toggleCustomMilestone(goalId, taskIndex) {
            if (!currentUser) return;

            try {
                const goalRef = db.collection('users')
                    .doc(currentUser.uid)
                    .collection('customGoals')
                    .doc(goalId);

                const goalDoc = await goalRef.get();
                if (!goalDoc.exists) return;

                const goalData = goalDoc.data();
                const task = goalData.tasks[taskIndex];
                task.completed = !task.completed;
                task.completedAt = task.completed ? firebase.firestore.FieldValue.serverTimestamp() : null;

                await goalRef.update({
                    tasks: goalData.tasks,
                    progress: calculateCustomGoalProgress({ tasks: goalData.tasks })
                });

                // Reload custom goals to refresh UI
                await loadCustomGoals();
            } catch (error) {
                console.error('Error toggling custom milestone:', error);
                alert('Error updating milestone. Please try again.');
            }
        }

        function signOut() {
            auth.signOut().then(() => {
                window.location.href = 'portal-login.html';
            });
        }
    </script>
</body>
</html>
