<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Training Sessions - CanineKind Client Portal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #D1E5F4 0%, #e8f4f8 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Portal Header */
        .portal-header {
            background: linear-gradient(135deg, #799972 0%, #8aaa83 100%);
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .portal-logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .portal-logo img {
            height: 50px;
            width: auto;
        }

        .portal-logo h1 {
            color: white;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .portal-nav {
            display: flex;
            gap: 1.5rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .portal-nav a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s;
            padding: 0.5rem 1rem;
            border-radius: 5px;
        }

        .portal-nav a:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .portal-nav a.active {
            background: rgba(255, 255, 255, 0.3);
            font-weight: 600;
        }

        .sign-out-link {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.85rem;
            padding: 0.4rem 0.8rem;
        }

        .sign-out-link:hover {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.9);
        }

        /* Page Container */
        .page-container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .page-header {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }

        .page-header h2 {
            color: #799972;
            font-size: 2.2em;
            margin-bottom: 10px;
        }

        .page-header p {
            color: #666;
            font-size: 1.1em;
        }

        /* Section Headers */
        .section-header {
            background: white;
            padding: 20px 25px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .section-header h3 {
            color: #799972;
            font-size: 1.5em;
            margin-bottom: 5px;
        }

        .section-header p {
            color: #666;
            font-size: 0.95em;
        }

        /* Sessions Grid */
        .sessions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .session-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border-left: 5px solid #4a90e2;
            cursor: pointer;
        }

        .session-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        .session-card.upcoming {
            border-left-color: #4a90e2;
        }

        .session-card.completed {
            border-left-color: #51cf66;
            opacity: 0.85;
        }

        .session-icon {
            font-size: 2.5em;
            margin-bottom: 15px;
        }

        .session-date {
            font-size: 1.3em;
            color: #333;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .session-time {
            color: #666;
            font-size: 1.1em;
            margin-bottom: 12px;
        }

        .session-type {
            display: inline-block;
            background: #e3f2fd;
            color: #1976d2;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .session-status {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #666;
            font-size: 0.9em;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            color: #666;
            margin-bottom: 10px;
        }

        .empty-state p {
            color: #999;
            margin-bottom: 20px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #799972 0%, #8aaa83 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(121, 153, 114, 0.3);
        }

        /* Training Reminders Styles */
        .reminder-level-group {
            margin-bottom: 1.5rem;
        }

        .reminder-level-header {
            background: linear-gradient(135deg, #799972 0%, #8aaa83 100%);
            color: white;
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            font-weight: 700;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 1rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .reminder-level-header:hover {
            box-shadow: 0 4px 12px rgba(121, 153, 114, 0.3);
        }

        .reminder-collapse-icon {
            font-size: 0.9rem;
            transition: transform 0.3s ease;
        }

        .reminder-level-group.collapsed .reminder-collapse-icon {
            transform: rotate(-90deg);
        }

        .reminder-level-content {
            max-height: 5000px;
            overflow: hidden;
            transition: max-height 0.4s ease, opacity 0.3s ease;
            opacity: 1;
        }

        .reminder-level-group.collapsed .reminder-level-content {
            max-height: 0;
            opacity: 0;
        }

        .reminder-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-left: 4px solid #799972;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }

        .reminder-card:hover {
            box-shadow: 0 4px 12px rgba(121, 153, 114, 0.15);
            transform: translateX(4px);
        }

        .reminder-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            cursor: pointer;
        }

        .reminder-card h3 {
            color: #2c3e50;
            font-size: 1.2rem;
            font-weight: 700;
            margin: 0;
        }

        .reminder-card-icon {
            font-size: 0.9rem;
            color: #799972;
            transition: transform 0.3s ease;
        }

        .reminder-card.collapsed .reminder-card-icon {
            transform: rotate(-90deg);
        }

        .reminder-card-content {
            max-height: 2000px;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            opacity: 1;
        }

        .reminder-card.collapsed .reminder-card-content {
            max-height: 0;
            opacity: 0;
        }

        .reminder-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .reminder-detail {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            border-left: 3px solid #799972;
        }

        .reminder-detail strong {
            display: block;
            color: #799972;
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .reminder-detail span {
            color: #2c3e50;
            font-size: 1rem;
        }

        .prep-instructions {
            background: #e8f5e9;
            padding: 1.25rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            border-left: 3px solid #799972;
        }

        .prep-instructions strong {
            display: block;
            color: #2e7d32;
            font-size: 0.95rem;
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .prep-instructions p {
            color: #1b5e20;
            line-height: 1.6;
            margin: 0;
        }

        .personal-note-section {
            background: #fff9e6;
            padding: 1.25rem;
            border-radius: 8px;
            border-left: 3px solid #f9a825;
        }

        .personal-note-section textarea {
            width: 100%;
            min-height: 80px;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.95rem;
            resize: vertical;
            transition: border-color 0.3s;
        }

        .personal-note-section textarea:focus {
            outline: none;
            border-color: #799972;
        }

        .save-note-btn {
            background: #799972;
            color: white;
            border: none;
            padding: 0.6rem 1.25rem;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 0.75rem;
            transition: all 0.3s;
        }

        .save-note-btn:hover {
            background: #6a8862;
            box-shadow: 0 2px 8px rgba(121, 153, 114, 0.3);
        }


        /* Mobile Styles */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .portal-nav {
                gap: 0.5rem;
                font-size: 0.9rem;
                justify-content: center;
            }

            .portal-nav a {
                padding: 0.4rem 0.8rem;
                font-size: 0.85rem;
            }

            .sign-out-link {
                font-size: 0.75rem;
                padding: 0.3rem 0.6rem;
                opacity: 0.6;
                margin-left: 1rem;
            }

            .page-header h2 {
                font-size: 1.8em;
            }

            .sessions-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Portal Header -->
    <header class="portal-header">
        <div class="header-content">
            <div class="portal-logo">
                <img src="https://i.imgur.com/OXiQWa3.jpeg" alt="CanineKind Logo">
                <h1>Client Portal</h1>
            </div>
            <nav class="portal-nav">
                <a href="portal-dashboard.html">Dashboard</a>
                <a href="portal-sessions.html" class="active">Sessions</a>
                <a href="portal-forms.html">Forms & Documents</a>
                <a href="portal-schedule.html">Weekly Schedule</a>
                <a href="portal-goals.html">Goals</a>
                <a href="portal-admin-dashboard.html" id="adminPortalLink" style="display: none; background-color: #4A90A4;">Admin Portal</a>
                <a href="#" class="sign-out-link" onclick="signOut(); return false;">Sign Out</a>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <div class="page-container">
        <!-- Page Header -->
        <div class="page-header">
            <h2>Training Sessions</h2>
            <p>View your upcoming and past training sessions</p>
        </div>

        <!-- Training Reminders Section -->
        <div id="trainingRemindersSection" style="display: none; margin-bottom: 3rem; background: white; padding: 2rem; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
            <h2 style="color: #2c3e50; font-size: 1.8rem; font-weight: 700; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 1px;">üìÖ Your Weekly Training Plan</h2>
            <p style="color: #666; font-size: 1.1rem; margin-bottom: 2rem;">Here's your at-home training plan based on your scheduled activities and goals</p>
            <div id="reminderCards"></div>
        </div>

        <!-- Upcoming Sessions Section -->
        <div class="section-header">
            <h3>Upcoming Sessions</h3>
            <p>Your scheduled training appointments</p>
        </div>

        <div class="sessions-grid" id="upcomingSessions">
            <!-- Upcoming sessions will be loaded here -->
        </div>

        <!-- Past Sessions Section -->
        <div class="section-header">
            <h3>üìã Past Sessions</h3>
            <p>Review previous training sessions and notes</p>
        </div>

        <div class="sessions-grid" id="pastSessions">
            <!-- Past sessions will be loaded here -->
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- Firebase Config -->
    <script src="firebase-config.js"></script>

    <script>
        let currentUser = null;
        let selectedGoals = {};

        // Training Prep Instructions for each goal at each level
        const TRAINING_PREP_INSTRUCTIONS = {
            'sit': {
                1: 'Bring small, soft training treats. Practice in a quiet area with minimal distractions. Keep sessions short (5-10 minutes).',
                2: 'Practice with mild distractions present. Bring high-value treats and work on duration.',
                3: 'Practice in public places with more distractions. Work on sit-stays with distance.',
                4: 'Master level - practice sit command in highly distracting environments and at a distance.'
            },
            'down': {
                1: 'Use a comfortable mat or towel for your dog. Bring soft treats and practice in a quiet space.',
                2: 'Practice down with mild distractions. Work on holding the position longer.',
                3: 'Practice in different locations and with moderate distractions.',
                4: 'Master level - down-stay in public places with high distractions.'
            },
            'recall': {
                1: 'Since we\'re still on level 1, make sure you bring your longline! Use high-value treats and practice in a safe, enclosed area.',
                2: 'Bring your longline for safety. Practice with mild distractions present. Use a special recall word.',
                3: 'Practice recall with moderate distractions. Begin working on distance recalls.',
                4: 'Master level recall - practice in highly distracting environments. Work towards reliable off-leash recall.'
            },
            'markers-release': {
                1: 'Bring a clicker or use a verbal marker ("Yes!"). Have plenty of small treats ready.',
                2: 'Practice clear, consistent markers. Work on timing and precision.',
                3: 'Use markers with more complex behaviors and in distracting environments.',
                4: 'Master level - markers should be second nature. Practice with advanced behaviors.'
            },
            'place': {
                1: 'Bring your dog\'s place mat or bed. Use treats to lure them to the spot. Practice in a quiet area.',
                2: 'Practice "place" with mild distractions. Work on duration and distance.',
                3: 'Use the place command in different locations. Increase distractions.',
                4: 'Master level - your dog should go to place and stay even in highly distracting environments.'
            },
            'crate-manners': {
                1: 'Make the crate comfortable with bedding and safe toys. Bring high-value treats for positive associations.',
                2: 'Practice longer duration crate time. Work on calm entry and exit.',
                3: 'Your dog should be comfortable in the crate for extended periods. Practice in different locations.',
                4: 'Master level - your dog should love their crate and be calm for extended periods.'
            },
            'boundaries-thresholds': {
                1: 'Practice at familiar doorways first. Use treats to reward waiting. Keep sessions short and positive.',
                2: 'Increase duration and practice at different thresholds. Add mild distractions.',
                3: 'Practice boundary respect in public spaces and new environments.',
                4: 'Master level - your dog should automatically wait at all thresholds and boundaries.'
            },
            'leave-it': {
                1: 'Start with low-value items. Use high-value treats as rewards. Practice in a controlled environment.',
                2: 'Increase difficulty with more tempting items. Practice on walks with real-world distractions.',
                3: 'Work on leave-it at a distance and with highly tempting objects.',
                4: 'Master level - your dog should reliably leave anything on command, even off-leash.'
            },
            'basic-engagement': {
                1: 'Bring your dog\'s favorite treats. Practice in a quiet area with minimal distractions. Keep sessions fun and short.',
                2: 'Practice engagement with mild distractions present. Work on increasing duration of focus.',
                3: 'Practice in busier environments. Your dog should check in regularly during walks.',
                4: 'Master level - your dog should be highly engaged and responsive even in distracting environments.'
            }
        };

        // Initialize Firebase and check authentication
        document.addEventListener('DOMContentLoaded', async () => {
            const initialized = initializeFirebase();

            if (!initialized) {
                alert('Failed to initialize Firebase');
                window.location.href = 'portal-login.html';
                return;
            }

            // Check authentication
            auth.onAuthStateChanged(async (user) => {
                if (!user) {
                    window.location.href = 'portal-login.html';
                } else {
                    currentUser = user;
                    await loadSessions();
                }
            });
        });

        // Load sessions for the user
        async function loadSessions() {
            console.log('üü¢ loadSessions() called');
            const upcomingGrid = document.getElementById('upcomingSessions');
            const pastGrid = document.getElementById('pastSessions');

            console.log('üî∑ Step 1: About to check admin status');
            // Check if user is admin and show admin portal link
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                console.log('üî∑ Step 2: Got user doc, checking admin role');
                if (userDoc.exists && userDoc.data().role === 'admin') {
                    document.getElementById('adminPortalLink').style.display = 'inline-block';
                }
                console.log('üî∑ Step 3: Admin check completed');
            } catch (error) {
                console.error('‚ùå Error checking admin status:', error);
            }

            console.log('üî∑ Step 4: Starting sessions try-catch block');
            try {
                // TODO: Fetch sessions from Firestore
                // For now, we'll use placeholder data structure
                // Real implementation will query Firestore for sessions

                // Firestore structure will be:
                // sessions/{sessionId}
                //   - clientEmail: string
                //   - date: timestamp
                //   - type: string
                //   - status: 'scheduled' | 'completed' | 'cancelled'
                //   - duration: number (minutes)
                //   - notes: object { pre, during, post }
                //   - homework: array

                console.log('üî∑ Step 5: About to call fetchUserSessions()');
                const sessions = await fetchUserSessions();
                console.log('üî∑ Step 6: fetchUserSessions() returned', sessions.length, 'sessions');

                if (sessions.length === 0) {
                    console.log('üî∑ Step 7: No sessions found, clearing grids');
                    upcomingGrid.innerHTML = '';
                    pastGrid.innerHTML = '';
                    return;
                }

                console.log('üî∑ Step 8: Separating upcoming and past sessions');
                // Separate upcoming and past sessions
                const now = new Date();
                const upcoming = sessions.filter(s => s.date > now);
                const past = sessions.filter(s => s.date <= now);
                console.log('üî∑ Step 9:', upcoming.length, 'upcoming,', past.length, 'past sessions');

                // Render upcoming sessions
                console.log('üî∑ Step 10: Rendering upcoming sessions');
                if (upcoming.length > 0) {
                    upcomingGrid.innerHTML = upcoming.map(session => renderSessionCard(session, 'upcoming')).join('');
                } else {
                    upcomingGrid.innerHTML = '<div class="empty-state"><p style="color: #999;">No upcoming sessions</p></div>';
                }

                // Render past sessions
                console.log('üî∑ Step 11: Rendering past sessions');
                if (past.length > 0) {
                    pastGrid.innerHTML = past.map(session => renderSessionCard(session, 'completed')).join('');
                } else {
                    pastGrid.innerHTML = '<div class="empty-state"><p style="color: #999;">No past sessions</p></div>';
                }

                console.log('üî∑ Step 12: Session rendering completed');

            } catch (error) {
                console.error('‚ùå Error loading sessions:', error);
                upcomingGrid.innerHTML = '<div class="empty-state"><p style="color: #dc3545;">Error loading sessions. Please refresh.</p></div>';
            }

            // Load training reminders
            console.log('üü° About to call loadTrainingReminders()');
            await loadTrainingReminders();
            console.log('üü¢ loadTrainingReminders() completed');
        }

        // Fetch user sessions from Firestore
        async function fetchUserSessions() {
            try {
                // Query top-level sessions collection filtered by clientId
                // Note: Removed .orderBy() to avoid requiring a composite index
                // We'll sort client-side instead
                const sessionsRef = db.collection('sessions')
                    .where('clientId', '==', currentUser.uid);

                const snapshot = await sessionsRef.get();

                // Map and sort client-side by sessionDate descending
                const sessions = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    date: doc.data().sessionDate.toDate()
                }));

                // Sort by date, newest first
                return sessions.sort((a, b) => b.date - a.date);
            } catch (error) {
                console.error('Error fetching sessions:', error);
                return [];
            }
        }

        // Render a session card
        function renderSessionCard(session, status) {
            const dateStr = session.date.toLocaleDateString('en-US', {
                weekday: 'short',
                month: 'short',
                day: 'numeric'
            });
            const timeStr = session.date.toLocaleTimeString('en-US', {
                hour: 'numeric',
                minute: '2-digit'
            });

            const statusText = status === 'upcoming' ? 'Scheduled' : 'Completed';

            return `
                <div class="session-card ${status}" onclick="viewSession('${session.id}')">
                    <div class="session-status-badge">${statusText}</div>
                    <div class="session-date">${dateStr}</div>
                    <div class="session-time">${timeStr}</div>
                    <div class="session-type">${session.type || 'Training Session'}</div>
                    <div class="session-status">
                        <span>${statusText}</span>
                        ${session.duration ? `‚Ä¢ ${session.duration} minutes` : ''}
                    </div>
                </div>
            `;
        }

        // View session details (will be implemented later)
        function viewSession(sessionId) {
            // TODO: Navigate to session detail page or open modal
            console.log('View session:', sessionId);
            alert('Session details view coming soon!');

            /* Future implementation:
            window.location.href = `portal-session-detail.html?id=${sessionId}`;
            */
        }

        // Training Reminders Functions
        async function loadTrainingReminders() {
            try {
                console.log('üîµ Loading training reminders...');
                const reminders = [];

                // First, load user's goals progress
                const goalsSnapshot = await db.collection('goalsProgress')
                    .where('userId', '==', currentUser.uid)
                    .get();

                console.log('üìä Found', goalsSnapshot.size, 'goals in progress');

                selectedGoals = {};
                goalsSnapshot.docs.forEach(doc => {
                    selectedGoals[doc.id] = {
                        id: doc.id,
                        ...doc.data()
                    };
                    console.log('  ‚úì Goal:', doc.id, '-', doc.data().title);
                });

                // Load schedule data from Firebase
                const scheduleDoc = await db.collection('users')
                    .doc(currentUser.uid)
                    .collection('schedules')
                    .doc('weekly')
                    .get();

                if (scheduleDoc.exists) {
                    const scheduleData = scheduleDoc.data();
                    console.log('üìÖ Schedule data loaded');

                    // Check each day and time slot for goal pairings
                    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

                    days.forEach(day => {
                        if (scheduleData[day]) {
                            Object.keys(scheduleData[day]).forEach(timeSlot => {
                                const activities = scheduleData[day][timeSlot];

                                if (Array.isArray(activities)) {
                                    activities.forEach(activityData => {
                                        // Check if this activity has paired goals
                                        let goalIds = [];
                                        if (typeof activityData === 'object') {
                                            // New format: goalIds array
                                            if (activityData.goalIds && Array.isArray(activityData.goalIds)) {
                                                goalIds = activityData.goalIds;
                                            }
                                            // Backward compatibility: old goalId string
                                            else if (activityData.goalId) {
                                                goalIds = [activityData.goalId];
                                            }
                                        }

                                        const activityName = typeof activityData === 'object' ? activityData.activity : activityData;
                                        const personalNote = typeof activityData === 'object' ? activityData.personalNote : null;

                                        if (goalIds.length > 0) {
                                            console.log('  üìç', day, timeSlot, '-', activityName, '- Goals:', goalIds);
                                        }

                                        // Create a reminder for each goal associated with this activity
                                        goalIds.forEach(goalId => {
                                            if (selectedGoals[goalId]) {
                                                const goal = selectedGoals[goalId];
                                                const goalLevel = goal.level;

                                                // Get prep instructions for this goal at this level
                                                const prepInstructions = TRAINING_PREP_INSTRUCTIONS[goalId]?.[goalLevel] ||
                                                                        'Bring treats and be ready to practice!';

                                                reminders.push({
                                                    goalTitle: goal.title,
                                                    goalId: goalId,
                                                    day: day,
                                                    time: timeSlot,
                                                    activity: activityName,
                                                    level: goalLevel,
                                                    prepInstructions: prepInstructions,
                                                    personalNote: personalNote
                                                });
                                                console.log('    ‚úÖ Created reminder for:', goal.title);
                                            } else {
                                                console.warn('    ‚ö†Ô∏è Goal not found in selectedGoals:', goalId);
                                            }
                                        });
                                    });
                                }
                            });
                        }
                    });
                } else {
                    console.log('‚ÑπÔ∏è No schedule data found');
                }

                console.log('üìã Total reminders created:', reminders.length);

                // Display reminders if any exist
                if (reminders.length > 0) {
                    console.log('‚úÖ Displaying training reminders');
                    displayTrainingReminders(reminders);
                } else {
                    console.log('‚ÑπÔ∏è No reminders to display');
                    displayNoReminders();
                }
            } catch (error) {
                console.error('‚ùå Error loading training reminders:', error);
                console.error('Error details:', error.message, error.stack);
                document.getElementById('trainingRemindersSection').style.display = 'none';
            }
        }

        function displayTrainingReminders(reminders) {
            const section = document.getElementById('trainingRemindersSection');
            const container = document.getElementById('reminderCards');

            // Group reminders by level
            const remindersByLevel = {};
            reminders.forEach(reminder => {
                const levelKey = reminder.level;
                if (!remindersByLevel[levelKey]) {
                    remindersByLevel[levelKey] = [];
                }
                remindersByLevel[levelKey].push(reminder);
            });

            let html = '';

            // Sort levels
            const sortedLevels = Object.keys(remindersByLevel).sort((a, b) => parseInt(a) - parseInt(b));

            sortedLevels.forEach(levelKey => {
                const level = parseInt(levelKey);
                const levelReminders = remindersByLevel[levelKey];
                const levelName = level === 0 ? 'Preparation' : `Level ${level}`;

                html += `
                    <div class="reminder-level-group collapsed" id="reminder-level-${level}">
                        <div class="reminder-level-header" onclick="toggleReminderLevel(${level})">
                            <span>${levelName} (${levelReminders.length} goal${levelReminders.length !== 1 ? 's' : ''})</span>
                            <span class="reminder-collapse-icon">‚ñº</span>
                        </div>
                        <div class="reminder-level-content">
                `;

                levelReminders.forEach((reminder, index) => {
                    const cardId = `reminder-card-${level}-${index}`;
                    const hasPersonalNote = reminder.personalNote && reminder.personalNote.trim() !== '';
                    html += `
                        <div class="reminder-card collapsed" id="${cardId}" data-day="${reminder.day}" data-time="${reminder.time}" data-goal-id="${reminder.goalId}" data-activity="${reminder.activity}">
                            <div class="reminder-card-header" onclick="toggleReminderCard('${cardId}')">
                                <h3>${reminder.goalTitle}</h3>
                                <span class="reminder-card-icon">‚ñº</span>
                            </div>
                            <div class="reminder-card-content">
                                <div class="reminder-info">
                                    <div class="reminder-detail">
                                        <strong>üìÖ When:</strong>
                                        <span>${reminder.day}, ${reminder.time}</span>
                                    </div>
                                    <div class="reminder-detail">
                                        <strong>üìç Where:</strong>
                                        <span>${reminder.activity}</span>
                                    </div>
                                </div>

                                <div class="prep-instructions">
                                    <strong>‚úÖ How to Prep:</strong>
                                    <p>${reminder.prepInstructions}</p>
                                </div>

                                <div class="personal-note-section">
                                    <div style="margin-bottom: 0.75rem;">
                                        <strong>üìù Personal Note for This Goal:</strong>
                                    </div>
                                    <p style="font-size: 0.85rem; color: #666; margin-bottom: 0.75rem; line-height: 1.4;">
                                        Add a custom note to yourself for this training session
                                    </p>
                                    <textarea
                                        id="note-${reminder.day}-${reminder.time}-${reminder.goalId}"
                                        placeholder="Example: Focus on high-value treats today..."
                                        style="width: 100%;"
                                    >${hasPersonalNote ? reminder.personalNote : ''}</textarea>
                                    <button class="save-note-btn"
                                        onclick="savePersonalNote('${reminder.day}', '${reminder.time}', '${reminder.goalId}', '${reminder.activity}')">
                                        Save Note
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
            section.style.display = 'block';
        }

        function displayNoReminders() {
            document.getElementById('trainingRemindersSection').style.display = 'none';
        }

        function toggleReminderLevel(level) {
            const group = document.getElementById(`reminder-level-${level}`);
            if (group) {
                group.classList.toggle('collapsed');
            }
        }

        function toggleReminderCard(cardId) {
            const card = document.getElementById(cardId);
            if (card) {
                card.classList.toggle('collapsed');
            }
        }

        async function savePersonalNote(day, time, goalId, activity) {
            const noteField = document.getElementById(`note-${day}-${time}-${goalId}`);
            const personalNote = noteField.value.trim();

            try {
                // Load current schedule
                const scheduleDoc = await db.collection('users')
                    .doc(currentUser.uid)
                    .collection('schedules')
                    .doc('weekly')
                    .get();

                if (!scheduleDoc.exists) {
                    alert('Schedule not found');
                    return;
                }

                const scheduleData = scheduleDoc.data();

                // Find and update the specific activity with this goal
                if (scheduleData[day] && scheduleData[day][time]) {
                    const activities = scheduleData[day][time];

                    // Find the activity that matches
                    for (let i = 0; i < activities.length; i++) {
                        if (typeof activities[i] === 'object' &&
                            activities[i].activity === activity &&
                            (activities[i].goalIds?.includes(goalId) || activities[i].goalId === goalId)) {
                            // Update the personal note
                            activities[i].personalNote = personalNote;
                            break;
                        }
                    }

                    // Save back to Firestore
                    await db.collection('users')
                        .doc(currentUser.uid)
                        .collection('schedules')
                        .doc('weekly')
                        .set(scheduleData);

                    alert('‚úì Personal note saved!');
                } else {
                    alert('Activity not found in schedule');
                }
            } catch (error) {
                console.error('Error saving personal note:', error);
                alert('Error saving note: ' + error.message);
            }
        }

        // Sign out function
        async function signOut() {
            try {
                await firebase.auth().signOut();
                window.location.href = 'portal-login.html';
            } catch (error) {
                console.error('Error signing out:', error);
            }
        }

        /*
        ==============================================
        ADMIN VERSION NOTES (for future implementation)
        ==============================================

        Admin-specific features to add:
        1. Button to "Create New Session"
        2. Ability to edit session notes
        3. View all clients' sessions (not filtered)
        4. Add session homework/tasks
        5. Upload photos/videos to sessions
        6. Mark sessions as completed/cancelled

        Suggested admin page: portal-sessions-admin.html
        - Same layout but with admin controls
        - Create/Edit/Delete sessions
        - Bulk actions
        */
    </script>
</body>
</html>
