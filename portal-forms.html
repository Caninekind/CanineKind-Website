<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forms & Documents - CanineKind Client Portal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #D1E5F4 0%, #e8f4f8 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Portal Header */
        .portal-header {
            background: linear-gradient(135deg, #799972 0%, #8aaa83 100%);
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .portal-logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .portal-logo img {
            height: 50px;
            width: auto;
        }

        .portal-logo h1 {
            color: white;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .portal-nav {
            display: flex;
            gap: 1.5rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .portal-nav a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s;
            padding: 0.5rem 1rem;
            border-radius: 5px;
        }

        .portal-nav a:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .portal-nav a.active {
            background: rgba(255, 255, 255, 0.3);
            font-weight: 600;
        }

        .sign-out-link {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.85rem;
            padding: 0.4rem 0.8rem;
        }

        .sign-out-link:hover {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.9);
        }

        /* Page Container */
        .page-container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .page-header {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }

        .page-header h2 {
            color: #799972;
            font-size: 2.2em;
            margin-bottom: 10px;
        }

        .page-header p {
            color: #666;
            font-size: 1.1em;
        }

        /* Documents Grid */
        .documents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        .document-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border-left: 5px solid #ccc;
        }

        .document-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        .document-card.completed {
            border-left-color: #51cf66;
        }

        .document-card.needs-signature {
            border-left-color: #ffa726;
        }

        .document-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .document-title {
            font-size: 1.3em;
            color: #333;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .document-description {
            color: #666;
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .document-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            padding: 8px 12px;
            border-radius: 5px;
            font-weight: 600;
            font-size: 0.9em;
        }

        .document-status.completed {
            background-color: #d4edda;
            color: #155724;
        }

        .document-status.needs-signature {
            background-color: #fff3cd;
            color: #856404;
        }

        .document-date {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 15px;
        }

        .document-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #799972 0%, #8aaa83 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(121, 153, 114, 0.3);
        }

        .btn-secondary {
            background: white;
            color: #799972;
            border: 2px solid #799972;
        }

        .btn-secondary:hover {
            background: #799972;
            color: white;
        }

        .btn-view {
            background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
            color: white;
        }

        .btn-view:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(74, 144, 226, 0.3);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            color: #666;
            margin-bottom: 10px;
        }

        .empty-state p {
            color: #999;
        }

        /* Mobile Styles */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .portal-nav {
                gap: 0.5rem;
                font-size: 0.9rem;
                justify-content: center;
            }

            .portal-nav a {
                padding: 0.4rem 0.8rem;
                font-size: 0.85rem;
            }

            .sign-out-link {
                font-size: 0.75rem;
                padding: 0.3rem 0.6rem;
                opacity: 0.6;
                margin-left: 1rem;
            }

            .page-header h2 {
                font-size: 1.8em;
            }

            .documents-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Portal Header -->
    <header class="portal-header">
        <div class="header-content">
            <div class="portal-logo">
                <img src="https://i.imgur.com/OXiQWa3.jpeg" alt="CanineKind Logo">
                <h1>Client Portal</h1>
            </div>
            <nav class="portal-nav">
                <a href="portal-dashboard.html">Dashboard</a>
                <a href="portal-sessions.html">Sessions</a>
                <a href="portal-forms.html" class="active">Forms & Documents</a>
                <a href="portal-schedule.html">Weekly Schedule</a>
                <a href="portal-goals.html">Goals</a>
                <a href="#" class="sign-out-link" onclick="signOut(); return false;">Sign Out</a>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <div class="page-container">
        <!-- Page Header -->
        <div class="page-header">
            <h2>Forms & Documents</h2>
            <p>Manage and sign all required legal documents and training agreements</p>
        </div>

        <!-- Signed Documents Section -->
        <div id="signedDocumentsSection" style="display: none; margin-bottom: 3rem;">
            <div class="page-header" style="margin-bottom: 1.5rem;">
                <h2 style="color: #51cf66;">‚úì Signed Documents</h2>
                <p>Your completed and signed documents</p>
            </div>
            <div class="documents-grid" id="signedDocumentsGrid">
                <!-- Signed documents will be loaded here -->
            </div>
        </div>

        <!-- Available Forms Section -->
        <div id="availableFormsSection">
            <div class="page-header" style="margin-bottom: 1.5rem;">
                <h2>üìã Forms Requiring Action</h2>
                <p>Please review and complete the following documents</p>
            </div>
            <div class="documents-grid" id="documentsGrid">
                <!-- Documents will be loaded here dynamically -->
            </div>

            <!-- Empty State (shown when no documents) -->
            <div class="empty-state" id="emptyState" style="display: none;">
                <div class="empty-state-icon">üéâ</div>
                <h3>All Documents Complete!</h3>
                <p>You have completed all required forms and documents.</p>
            </div>
        </div>

        <!-- Past Submissions Section -->
        <div id="pastSubmissionsSection" style="margin-top: 3rem; display: none;">
            <div class="page-header" style="margin-bottom: 1.5rem;">
                <h2>Your Past Submissions</h2>
                <p>View your previously submitted forms and documents</p>
            </div>
            <div id="pastSubmissionsList" style="display: flex; flex-direction: column; gap: 1rem;">
                <!-- Past submissions will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <!-- Firebase Config -->
    <script src="firebase-config.js"></script>

    <script>
        let currentUser = null;

        // Initialize Firebase and check authentication
        document.addEventListener('DOMContentLoaded', async () => {
            const initialized = initializeFirebase();

            if (!initialized) {
                alert('Failed to initialize Firebase');
                window.location.href = 'portal-login.html';
                return;
            }

            // Check authentication
            auth.onAuthStateChanged(async (user) => {
                if (!user) {
                    window.location.href = 'portal-login.html';
                } else {
                    currentUser = user;
                    await loadDocuments();
                    await loadPastSubmissions();
                }
            });
        });

        // Helper function to get signed document from Firestore
        async function getSignedDocument(userId, documentId) {
            try {
                const docRef = await db.collection('users').doc(userId)
                    .collection('signedDocuments').doc(documentId).get();

                if (docRef.exists) {
                    return docRef.data();
                }
                return null;
            } catch (error) {
                console.error('Error fetching signed document:', error);
                return null;
            }
        }

        // Load all documents for the user
        async function loadDocuments() {
            const documentsGrid = document.getElementById('documentsGrid');
            const signedDocumentsGrid = document.getElementById('signedDocumentsGrid');
            const signedDocumentsSection = document.getElementById('signedDocumentsSection');
            const emptyState = document.getElementById('emptyState');

            // Define available documents (you can expand this list later)
            const availableDocuments = [
                {
                    id: 'legal-agreement',
                    title: 'Legal Agreement & Consent Forms',
                    description: 'Comprehensive agreement covering training services, liability, privacy policy, and cancellation terms.',
                    icon: 'üìã'
                },
                {
                    id: 'intake-questionnaire',
                    title: 'PRE-SESSION INTAKE',
                    description: 'This questionnaire will ask you some quick but more in depth questions about your dog\'s behavior. This questionnaire should take you less than 10 minutes but please make sure to read each option carefully.',
                    icon: 'üìù'
                }
            ];

            // Check status of each document
            const availableHTML = [];
            const signedHTML = [];

            for (const doc of availableDocuments) {
                let statusHTML, actionsHTML, cardClass;

                // Handle different document types
                if (doc.id === 'intake-questionnaire') {
                    // For intake questionnaire - always show in available forms
                    statusHTML = `<div class="document-status needs-signature">
                        <span>Action Required</span>
                       </div>
                       <div class="document-date">
                        Please complete this questionnaire
                       </div>`;

                    actionsHTML = `<a href="portal-intake-form.html" class="btn btn-primary">Complete Questionnaire</a>`;
                    cardClass = 'needs-signature';

                    availableHTML.push(`
                        <div class="document-card ${cardClass}">
                            <div class="document-icon">${doc.icon}</div>
                            <div class="document-title">${doc.title}</div>
                            <div class="document-description">${doc.description}</div>
                            ${statusHTML}
                            <div class="document-actions">
                                ${actionsHTML}
                            </div>
                        </div>
                    `);
                } else {
                    // For legal agreement and other signable documents
                    const signedDoc = await getSignedDocument(currentUser.uid, doc.id);
                    const isCompleted = signedDoc !== null;

                    if (isCompleted) {
                        // Add to signed documents section
                        const signedDate = new Date(signedDoc.signedAt.toDate()).toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });

                        signedHTML.push(`
                            <div class="document-card completed">
                                <div class="document-icon">${doc.icon}</div>
                                <div class="document-title">${doc.title}</div>
                                <div class="document-description">${doc.description}</div>
                                <div class="document-status completed">
                                    <span>‚úì</span>
                                    <span>Signed & Completed</span>
                                </div>
                                <div class="document-date">
                                    Signed on ${signedDate}
                                </div>
                                <div class="document-actions">
                                    <a href="${signedDoc.pdfURL}" target="_blank" class="btn btn-view">View Signed PDF</a>
                                    <button onclick="viewLegalAgreement()" class="btn btn-secondary" style="margin-left: 0.5rem;">View Agreement Language</button>
                                </div>
                            </div>
                        `);
                    } else {
                        // Add to available forms section
                        statusHTML = `<div class="document-status needs-signature">
                            <span>‚ö†Ô∏è</span>
                            <span>Signature Required</span>
                           </div>
                           <div class="document-date">
                            Please review and sign this document
                           </div>`;

                        actionsHTML = `<a href="portal-sign-document.html?doc=${doc.id}" class="btn btn-primary">Review & Sign</a>`;
                        cardClass = 'needs-signature';

                        availableHTML.push(`
                            <div class="document-card ${cardClass}">
                                <div class="document-icon">${doc.icon}</div>
                                <div class="document-title">${doc.title}</div>
                                <div class="document-description">${doc.description}</div>
                                ${statusHTML}
                                <div class="document-actions">
                                    ${actionsHTML}
                                </div>
                            </div>
                        `);
                    }
                }
            }

            // Display signed documents section if there are any
            if (signedHTML.length > 0) {
                signedDocumentsGrid.innerHTML = signedHTML.join('');
                signedDocumentsSection.style.display = 'block';
            } else {
                signedDocumentsSection.style.display = 'none';
            }

            // Display available forms
            if (availableHTML.length > 0) {
                documentsGrid.innerHTML = availableHTML.join('');
                emptyState.style.display = 'none';
            } else {
                documentsGrid.innerHTML = '';
                emptyState.style.display = 'block';
            }
        }

        // Load past submissions for this client
        async function loadPastSubmissions() {
            const section = document.getElementById('pastSubmissionsSection');
            const list = document.getElementById('pastSubmissionsList');

            try {
                // Query submissions for this user (without orderBy to avoid index requirement)
                const submissionsSnapshot = await db.collection('formSubmissions')
                    .where('userId', '==', currentUser.uid)
                    .get();

                if (submissionsSnapshot.empty) {
                    section.style.display = 'none';
                    return;
                }

                // Sort by submittedAt in JavaScript (client-side)
                const submissions = submissionsSnapshot.docs
                    .map(doc => ({ id: doc.id, ...doc.data() }))
                    .sort((a, b) => {
                        const dateA = a.submittedAt?.toDate() || new Date(0);
                        const dateB = b.submittedAt?.toDate() || new Date(0);
                        return dateB - dateA; // Descending order (most recent first)
                    })
                    .slice(0, 10); // Limit to 10 most recent

                section.style.display = 'block';
                let html = '';

                submissions.forEach(submission => {
                    const submittedDate = submission.submittedAt?.toDate() || new Date();
                    const formattedDate = submittedDate.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    html += `
                        <div class="document-card completed" style="cursor: pointer;" onclick="viewMySubmission('${submission.id}')">
                            <div class="document-icon">‚úÖ</div>
                            <div class="document-title">${submission.formTitle || 'Form Submission'}</div>
                            <div class="document-description">Submitted on ${formattedDate}</div>
                            <div class="document-status completed">
                                <span>‚úì</span>
                                <span>Submitted</span>
                            </div>
                            <div class="document-actions">
                                <button class="btn btn-primary" onclick="event.stopPropagation(); viewMySubmission('${submission.id}')">View Details</button>
                            </div>
                        </div>
                    `;
                });

                list.innerHTML = html;

            } catch (error) {
                console.error('Error loading past submissions:', error);
                section.style.display = 'none';
            }
        }

        async function viewMySubmission(submissionId) {
            try {
                const doc = await db.collection('formSubmissions').doc(submissionId).get();
                if (!doc.exists) {
                    alert('Submission not found');
                    return;
                }

                const submission = doc.data();
                const formData = submission.formData || {};

                // Create a formatted display
                let content = `
                    <div style="max-height: 70vh; overflow-y: auto; padding: 1.5rem;">
                        <h2 style="color: #799972; margin-bottom: 1rem;">${submission.formTitle}</h2>
                        <p style="color: #666; margin-bottom: 1.5rem;">
                            <strong>Submitted:</strong> ${submission.submittedAt?.toDate().toLocaleString()}<br>
                            <strong>Status:</strong> <span style="color: #51cf66; font-weight: 600;">‚úì Received</span>
                        </p>
                        <hr style="margin-bottom: 1.5rem;">
                        <div style="display: grid; gap: 1rem;">
                `;

                Object.entries(formData).forEach(([key, value]) => {
                    if (key === 'access_key' || key === 'subject' || key === 'from_name' || key === 'botcheck') {
                        return;
                    }

                    const formattedKey = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    const formattedValue = Array.isArray(value) ? value.join(', ') : value;

                    content += `
                        <div style="background: #f8f9fa; padding: 0.75rem; border-radius: 5px;">
                            <strong style="color: #2c3e50;">${formattedKey}:</strong>
                            <p style="margin: 0.5rem 0 0 0; color: #555;">${formattedValue || '(not provided)'}</p>
                        </div>
                    `;
                });

                content += '</div></div>';

                // Create modal
                const modal = document.createElement('div');
                modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000; padding: 2rem;';
                modal.innerHTML = `
                    <div style="background: white; border-radius: 10px; max-width: 800px; width: 100%; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                        ${content}
                        <div style="padding: 1rem; border-top: 1px solid #e0e0e0; text-align: right;">
                            <button onclick="this.closest('[style*=fixed]').remove()" style="background: #6c757d; color: white; border: none; padding: 0.6rem 1.5rem; border-radius: 5px; cursor: pointer; font-weight: 500;">
                                Close
                            </button>
                        </div>
                    </div>
                `;

                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });

                document.body.appendChild(modal);

            } catch (error) {
                console.error('Error viewing submission:', error);
                alert('Error loading submission details');
            }
        }

        // View legal agreement language
        function viewLegalAgreement() {
            const legalContent = `
                <div style="max-height: 70vh; overflow-y: auto; padding: 1.5rem;">
                    <h2 style="color: #799972; margin-bottom: 1rem;">Legal Agreement & Consent Forms</h2>
                    <p style="color: #666; margin-bottom: 1.5rem;">This is the complete legal agreement you signed.</p>
                    <hr style="margin-bottom: 1.5rem;">

                    <h3 style="color: #2c3e50; margin-top: 1.5rem;">1. Scope of Services</h3>
                    <p style="line-height: 1.6; color: #555;">CanineKind Training provides professional dog training services including, but not limited to, behavior modification, obedience training, and consultation services. All services are customized based on the individual needs of each dog and owner.</p>

                    <h3 style="color: #2c3e50; margin-top: 1.5rem;">2. Training Methods & Tools Acknowledgment</h3>
                    <p style="line-height: 1.6; color: #555;">I understand that CanineKind Training uses positive reinforcement-based training methods. I acknowledge that training tools and techniques will be selected based on my dog's individual needs and temperament. I agree to follow all training protocols and recommendations provided by CanineKind Training.</p>

                    <h3 style="color: #2c3e50; margin-top: 1.5rem;">3. Assumption of Risk</h3>
                    <p style="line-height: 1.6; color: #555;">I understand that dog training involves inherent risks, including but not limited to bites, scratches, and other injuries from my dog or other dogs. I voluntarily assume all risks associated with my participation in training services and agree that CanineKind Training is not responsible for any injuries or damages that may occur.</p>

                    <h3 style="color: #2c3e50; margin-top: 1.5rem;">4. Liability Release & Indemnification</h3>
                    <p style="line-height: 1.6; color: #555;">I hereby release, waive, and discharge CanineKind Training, its owners, employees, and agents from any and all liability, claims, demands, or causes of action arising from my participation in training services. I agree to indemnify and hold harmless CanineKind Training from any claims arising from my dog's behavior or actions.</p>

                    <h3 style="color: #2c3e50; margin-top: 1.5rem;">5. Health & Behavior Disclosure</h3>
                    <p style="line-height: 1.6; color: #555;">I certify that my dog is current on all required vaccinations and is in good health. I have disclosed all known behavioral issues, medical conditions, and bite history. I understand that failure to disclose this information may result in termination of services.</p>

                    <h3 style="color: #2c3e50; margin-top: 1.5rem;">6. Privacy Policy</h3>
                    <p style="line-height: 1.6; color: #555;">CanineKind Training respects your privacy. All personal information collected will be used solely for providing training services and will not be shared with third parties without your consent, except as required by law.</p>

                    <h3 style="color: #2c3e50; margin-top: 1.5rem;">7. Cancellation & Refund Policy</h3>
                    <p style="line-height: 1.6; color: #555;">Cancellations must be made at least 24 hours in advance. Late cancellations or no-shows may result in a fee. Refunds are provided on a case-by-case basis at the discretion of CanineKind Training.</p>
                </div>
            `;

            // Create modal
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000; padding: 2rem;';
            modal.innerHTML = `
                <div style="background: white; border-radius: 10px; max-width: 900px; width: 100%; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                    ${legalContent}
                    <div style="padding: 1rem; border-top: 1px solid #e0e0e0; text-align: right;">
                        <button onclick="this.closest('[style*=fixed]').remove()" style="background: #6c757d; color: white; border: none; padding: 0.6rem 1.5rem; border-radius: 5px; cursor: pointer; font-weight: 500;">
                            Close
                        </button>
                    </div>
                </div>
            `;

            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });

            document.body.appendChild(modal);
        }

        // Sign out function
        async function signOut() {
            try {
                await firebase.auth().signOut();
                window.location.href = 'portal-login.html';
            } catch (error) {
                console.error('Error signing out:', error);
            }
        }
    </script>
</body>
</html>
