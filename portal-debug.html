<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug - CanineKind Portal</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .debug-box {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .debug-box h2 {
            color: #799972;
            margin-top: 0;
        }
        .debug-box pre {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .error {
            color: #d32f2f;
        }
        .success {
            color: #388e3c;
        }
        button {
            background-color: #799972;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background-color: #5a7a4f;
        }
    </style>
</head>
<body>
    <h1>üîç Portal Debug Tool</h1>

    <div class="debug-box">
        <h2>1. Authentication Status</h2>
        <p id="authStatus">Checking...</p>
    </div>

    <div class="debug-box">
        <h2>2. Current User Info (from Google OAuth)</h2>
        <pre id="userInfo">Loading...</pre>
    </div>

    <div class="debug-box">
        <h2>3. Firestore User Data</h2>
        <pre id="firestoreData">Loading...</pre>
    </div>

    <div class="debug-box">
        <h2>4. Approval Check Result</h2>
        <pre id="approvalCheck">Loading...</pre>
    </div>

    <div class="debug-box">
        <h2>5. Admin Check Result</h2>
        <pre id="adminCheck">Loading...</pre>
    </div>

    <div class="debug-box">
        <h2>Actions</h2>
        <button onclick="refreshData()">üîÑ Refresh Data</button>
        <button onclick="window.location.href='portal-login.html'">‚Üê Back to Login</button>
        <button onclick="window.location.href='portal-dashboard.html'">‚Üí Go to Dashboard</button>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- Firebase Config -->
    <script src="firebase-config.js"></script>

    <script>
        async function loadDebugInfo() {
            const initialized = initializeFirebase();

            if (!initialized) {
                document.getElementById('authStatus').innerHTML = '<span class="error">‚ùå Firebase failed to initialize</span>';
                return;
            }

            auth.onAuthStateChanged(async (user) => {
                if (!user) {
                    document.getElementById('authStatus').innerHTML = '<span class="error">‚ùå Not authenticated - please sign in first</span>';
                    document.getElementById('userInfo').textContent = 'No user signed in';
                    document.getElementById('firestoreData').textContent = 'N/A';
                    document.getElementById('approvalCheck').textContent = 'N/A';
                    document.getElementById('adminCheck').textContent = 'N/A';
                } else {
                    // Auth status
                    document.getElementById('authStatus').innerHTML = '<span class="success">‚úÖ Authenticated with Google</span>';

                    // User info from Google OAuth
                    const userInfoObj = {
                        email: user.email,
                        displayName: user.displayName,
                        uid: user.uid,
                        photoURL: user.photoURL
                    };
                    document.getElementById('userInfo').textContent = JSON.stringify(userInfoObj, null, 2);

                    // Firestore data
                    try {
                        const firestoreUserData = await getUserData(user.email);
                        if (firestoreUserData) {
                            document.getElementById('firestoreData').innerHTML = '<span class="success">‚úÖ Found in Firestore:</span>\n' + JSON.stringify(firestoreUserData, null, 2);
                        } else {
                            document.getElementById('firestoreData').innerHTML = '<span class="error">‚ùå NOT found in Firestore</span>\n\nPossible issues:\n1. Document ID doesn\'t match email\n2. Collection name is wrong\n3. Firestore permissions issue';
                        }
                    } catch (error) {
                        document.getElementById('firestoreData').innerHTML = '<span class="error">‚ùå Error reading Firestore:</span>\n' + error.message;
                    }

                    // Approval check
                    try {
                        const approval = await checkUserApproval(user.email);
                        const approvalStatus = {
                            exists: approval.exists,
                            approved: approval.approved,
                            role: approval.role,
                            error: approval.error || null
                        };

                        let statusText = '';
                        if (approval.exists && approval.approved) {
                            statusText = '<span class="success">‚úÖ User is APPROVED</span>\n';
                        } else if (approval.exists && !approval.approved) {
                            statusText = '<span class="error">‚ùå User EXISTS but NOT APPROVED</span>\n';
                        } else {
                            statusText = '<span class="error">‚ùå User DOES NOT EXIST in database</span>\n';
                        }

                        document.getElementById('approvalCheck').innerHTML = statusText + JSON.stringify(approvalStatus, null, 2);
                    } catch (error) {
                        document.getElementById('approvalCheck').innerHTML = '<span class="error">‚ùå Error checking approval:</span>\n' + error.message;
                    }

                    // Admin check
                    try {
                        const adminStatus = await isUserAdmin();
                        if (adminStatus) {
                            document.getElementById('adminCheck').innerHTML = '<span class="success">‚úÖ User IS an ADMIN</span>\n\nResult: ' + adminStatus;
                        } else {
                            document.getElementById('adminCheck').innerHTML = '<span class="error">‚ùå User is NOT an admin</span>\n\nResult: ' + adminStatus;
                        }
                    } catch (error) {
                        document.getElementById('adminCheck').innerHTML = '<span class="error">‚ùå Error checking admin status:</span>\n' + error.message;
                    }
                }
            });
        }

        function refreshData() {
            location.reload();
        }

        // Load debug info on page load
        window.addEventListener('DOMContentLoaded', loadDebugInfo);
    </script>
</body>
</html>
