<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Management - Admin Portal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .header h1 {
            color: #667eea;
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            color: #666;
        }

        .nav-links {
            margin-top: 1rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .nav-links a {
            color: #667eea;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border: 2px solid #667eea;
            border-radius: 5px;
            transition: all 0.3s;
        }

        .nav-links a:hover {
            background: #667eea;
            color: white;
        }

        .email-sections {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .email-card {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .email-card h2 {
            color: #667eea;
            font-size: 1.5rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 0.5rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            min-height: 150px;
            resize: vertical;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 5px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
        }

        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-small {
            width: auto;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }

        .template-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .template-option {
            padding: 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .template-option:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .template-option.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .template-option h4 {
            margin-bottom: 0.5rem;
        }

        .template-option p {
            font-size: 0.9rem;
            color: #666;
        }

        .template-option.active p {
            color: rgba(255,255,255,0.9);
        }

        .success-message {
            background: #51cf66;
            color: white;
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
            display: none;
        }

        .error-message {
            background: #ff6b6b;
            color: white;
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
            display: none;
        }

        .invitation-item {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            margin-bottom: 1rem;
        }

        .invitation-item.accepted {
            border-left-color: #51cf66;
        }

        .invitation-item.expired {
            border-left-color: #ff6b6b;
            opacity: 0.7;
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-pending {
            background: #ffd43b;
            color: #333;
        }

        .status-accepted {
            background: #51cf66;
            color: white;
        }

        .status-expired {
            background: #ff6b6b;
            color: white;
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 0.75rem 1.5rem;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab:hover {
            color: #667eea;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #666;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìß Email Management</h1>
            <p>Send invitation emails to new clients and track their acceptance status</p>
            <div class="nav-links">
                <a href="portal-admin.html">‚Üê Back to Dashboard</a>
                <a href="portal-admin-forms.html">Forms</a>
                <a href="portal-admin-schedule.html">Schedule</a>
            </div>
        </div>

        <div class="email-sections">
            <!-- Send Invitation to New Client -->
            <div class="email-card">
                <h2>üì® Invite New Client</h2>
                <p style="color: #666; margin-bottom: 1.5rem;">Send an invitation email to a new client who paid on Square</p>

                <div class="success-message" id="inviteSuccess">
                    ‚úì Invitation email sent successfully!
                </div>
                <div class="error-message" id="inviteError"></div>

                <form id="inviteForm">
                    <div class="form-group">
                        <label for="newClientEmail">Client Email *</label>
                        <input type="email" id="newClientEmail" required placeholder="client@example.com">
                    </div>

                    <div class="form-group">
                        <label for="newClientName">Client Name (Optional)</label>
                        <input type="text" id="newClientName" placeholder="John Doe">
                    </div>

                    <button type="submit" class="btn" id="inviteBtn">
                        Send Invitation Email
                    </button>
                </form>
            </div>

            <!-- Email Existing Client -->
            <div class="email-card">
                <h2>‚úâÔ∏è Email Existing Client</h2>
                <p style="color: #666; margin-bottom: 1.5rem;">Send an email to a client already in your system</p>

                <div class="success-message" id="emailSuccess">
                    ‚úì Email sent successfully!
                </div>
                <div class="error-message" id="emailError"></div>

                <form id="emailForm">
                    <div class="form-group">
                        <label for="clientSelect">Select Client *</label>
                        <select id="clientSelect" required>
                            <option value="">Loading clients...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Email Template</label>
                        <div class="template-selector">
                            <div class="template-option active" data-template="custom">
                                <h4>üìù Custom</h4>
                                <p>Write your own message</p>
                            </div>
                            <div class="template-option" data-template="reminder">
                                <h4>‚è∞ Reminder</h4>
                                <p>Schedule next session</p>
                            </div>
                            <div class="template-option" data-template="followup">
                                <h4>üëã Follow-up</h4>
                                <p>Check-in message</p>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="emailSubject">Subject *</label>
                        <input type="text" id="emailSubject" required placeholder="Email subject">
                    </div>

                    <div class="form-group">
                        <label for="emailMessage">Message *</label>
                        <textarea id="emailMessage" required placeholder="Write your message here..."></textarea>
                    </div>

                    <button type="submit" class="btn" id="emailBtn">
                        Send Email
                    </button>
                </form>
            </div>
        </div>

        <!-- Invitation Tracking -->
        <div class="email-card">
            <h2>üéØ Invitation Tracking</h2>
            <p style="color: #666; margin-bottom: 1.5rem;">Monitor the status of client invitations</p>

            <div class="tabs">
                <button class="tab active" onclick="switchTab('all')">All Invitations</button>
                <button class="tab" onclick="switchTab('pending')">Pending</button>
                <button class="tab" onclick="switchTab('accepted')">Accepted</button>
                <button class="tab" onclick="switchTab('expired')">Expired</button>
            </div>

            <div id="invitationsContainer">
                <div class="empty-state">
                    <div class="empty-state-icon">üì≠</div>
                    <p>No invitations sent yet</p>
                </div>
            </div>
        </div>

        <!-- Email History -->
        <div class="email-card">
            <h2>üìã Recent Email Activity</h2>
            <div id="emailHistory">
                <div class="empty-state">
                    <div class="empty-state-icon">üìß</div>
                    <p>No emails sent yet</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script>
        let currentUser = null;
        let allInvitations = [];
        let currentFilter = 'all';
        const functions = firebase.functions();
        const db = firebase.firestore();

        document.addEventListener('DOMContentLoaded', async () => {
            const initialized = initializeFirebase();
            if (!initialized) {
                window.location.href = 'portal-login.html';
                return;
            }

            firebase.auth().onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    const isAdmin = await checkAdminStatus();
                    if (!isAdmin) {
                        alert('Access denied. Admin privileges required.');
                        window.location.href = 'portal-dashboard.html';
                        return;
                    }
                    loadClients();
                    loadInvitations();
                    loadEmailHistory();
                } else {
                    window.location.href = 'portal-login.html';
                }
            });
        });

        async function checkAdminStatus() {
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                return userDoc.exists && userDoc.data().role === 'admin';
            } catch (error) {
                console.error('Error checking admin status:', error);
                return false;
            }
        }

        // Load clients for dropdown
        async function loadClients() {
            try {
                const snapshot = await db.collection('users')
                    .where('role', '==', 'client')
                    .get();

                const select = document.getElementById('clientSelect');
                let options = '<option value="">-- Select a client --</option>';

                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const name = data.displayName || data.name || data.email;
                    options += `<option value="${doc.id}" data-email="${data.email}" data-name="${name}">${name} (${data.email})</option>`;
                });

                select.innerHTML = options;
            } catch (error) {
                console.error('Error loading clients:', error);
            }
        }

        // Template selection
        document.querySelectorAll('.template-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.template-option').forEach(opt => opt.classList.remove('active'));
                this.classList.add('active');

                const template = this.dataset.template;
                const subjectField = document.getElementById('emailSubject');
                const messageField = document.getElementById('emailMessage');

                if (template === 'reminder') {
                    subjectField.value = 'Time to Schedule Your Next Training Session';
                    messageField.value = `Hi [Client Name],

I hope you and your pup are doing well! I wanted to reach out to see if you'd like to schedule your next training session.

We've made great progress so far, and I'd love to continue working together to achieve your training goals.

Please let me know your availability, and we can get something on the calendar.

Looking forward to seeing you both soon!

Best regards,
CanineKind Training`;
                } else if (template === 'followup') {
                    subjectField.value = 'Checking In - How Is Training Going?';
                    messageField.value = `Hi [Client Name],

I wanted to check in and see how things are going with your dog's training!

Have you noticed any improvements? Are there any challenges you'd like to discuss?

I'm here to support you, so please don't hesitate to reach out if you have any questions or need additional guidance.

Best regards,
CanineKind Training`;
                } else {
                    subjectField.value = '';
                    messageField.value = '';
                }
            });
        });

        // Send invitation email
        document.getElementById('inviteForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const email = document.getElementById('newClientEmail').value;
            const name = document.getElementById('newClientName').value || 'New Client';
            const btn = document.getElementById('inviteBtn');
            const successMsg = document.getElementById('inviteSuccess');
            const errorMsg = document.getElementById('inviteError');

            btn.disabled = true;
            btn.textContent = 'Sending...';
            successMsg.style.display = 'none';
            errorMsg.style.display = 'none';

            try {
                // Create invitation record
                const invitationToken = generateToken();
                await db.collection('invitations').add({
                    email: email,
                    name: name,
                    token: invitationToken,
                    status: 'pending',
                    sentAt: firebase.firestore.FieldValue.serverTimestamp(),
                    sentBy: currentUser.uid,
                    expiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000) // 7 days
                });

                // Call Firebase Function to send invitation
                const sendInvitation = functions.httpsCallable('sendClientInvitation');
                await sendInvitation({
                    email: email,
                    name: name,
                    token: invitationToken
                });

                successMsg.style.display = 'block';
                document.getElementById('inviteForm').reset();
                loadInvitations();

                setTimeout(() => {
                    successMsg.style.display = 'none';
                }, 5000);
            } catch (error) {
                console.error('Error sending invitation:', error);
                errorMsg.textContent = '‚ùå Error: ' + (error.message || 'Failed to send invitation');
                errorMsg.style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.textContent = 'Send Invitation Email';
            }
        });

        // Generate random token
        function generateToken() {
            return Math.random().toString(36).substring(2) + Date.now().toString(36);
        }

        // Send email to existing client
        document.getElementById('emailForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const select = document.getElementById('clientSelect');
            const selectedOption = select.options[select.selectedIndex];
            const clientId = select.value;
            const email = selectedOption.dataset.email;
            const name = selectedOption.dataset.name;
            const subject = document.getElementById('emailSubject').value;
            let message = document.getElementById('emailMessage').value;

            // Replace [Client Name] placeholder
            message = message.replace(/\[Client Name\]/g, name.split(' ')[0] || name);

            const btn = document.getElementById('emailBtn');
            const successMsg = document.getElementById('emailSuccess');
            const errorMsg = document.getElementById('emailError');

            btn.disabled = true;
            btn.textContent = 'Sending...';
            successMsg.style.display = 'none';
            errorMsg.style.display = 'none';

            try {
                // Call Firebase Function to send email
                const sendEmail = functions.httpsCallable('sendClientEmail');
                await sendEmail({
                    to: email,
                    subject: subject,
                    message: message,
                    clientId: clientId,
                    clientName: name
                });

                successMsg.style.display = 'block';
                document.getElementById('emailForm').reset();
                loadEmailHistory();

                setTimeout(() => {
                    successMsg.style.display = 'none';
                }, 5000);
            } catch (error) {
                console.error('Error sending email:', error);
                errorMsg.textContent = '‚ùå Error: ' + (error.message || 'Failed to send email');
                errorMsg.style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.textContent = 'Send Email';
            }
        });

        // Load invitations
        async function loadInvitations() {
            try {
                const snapshot = await db.collection('invitations')
                    .orderBy('sentAt', 'desc')
                    .get();

                allInvitations = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                displayInvitations();
            } catch (error) {
                console.error('Error loading invitations:', error);
            }
        }

        // Tab switching
        function switchTab(filter) {
            currentFilter = filter;
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            displayInvitations();
        }

        // Display invitations based on filter
        function displayInvitations() {
            const container = document.getElementById('invitationsContainer');
            const now = new Date();

            let filtered = allInvitations.filter(inv => {
                // Update expired status
                if (inv.status === 'pending' && inv.expiresAt && inv.expiresAt.toDate() < now) {
                    inv.status = 'expired';
                }

                if (currentFilter === 'all') return true;
                return inv.status === currentFilter;
            });

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <p>No ${currentFilter === 'all' ? '' : currentFilter} invitations</p>
                    </div>
                `;
                return;
            }

            let html = '';
            filtered.forEach(inv => {
                const sentDate = inv.sentAt?.toDate().toLocaleString() || 'Unknown';
                const acceptedDate = inv.acceptedAt?.toDate().toLocaleString();
                const expiresDate = inv.expiresAt?.toDate().toLocaleDateString();

                html += `
                    <div class="invitation-item ${inv.status}">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <div>
                                <h3 style="color: #333; margin-bottom: 0.5rem;">${inv.name || 'New Client'}</h3>
                                <p style="color: #666; font-size: 0.9rem;">${inv.email}</p>
                            </div>
                            <span class="status-badge status-${inv.status}">
                                ${inv.status.toUpperCase()}
                            </span>
                        </div>
                        <div style="display: grid; gap: 0.5rem; font-size: 0.9rem; color: #666;">
                            <div><strong>Sent:</strong> ${sentDate}</div>
                            ${inv.status === 'accepted' && acceptedDate ? `<div><strong>Accepted:</strong> ${acceptedDate}</div>` : ''}
                            ${inv.status === 'pending' ? `<div><strong>Expires:</strong> ${expiresDate}</div>` : ''}
                        </div>
                        ${inv.status === 'pending' ? `
                            <div style="margin-top: 1rem;">
                                <button onclick="resendInvitation('${inv.id}')" class="btn btn-small">
                                    üîÑ Resend Invitation
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Resend invitation
        async function resendInvitation(invitationId) {
            try {
                const inv = allInvitations.find(i => i.id === invitationId);
                if (!inv) return;

                const sendInvitation = functions.httpsCallable('sendClientInvitation');
                await sendInvitation({
                    email: inv.email,
                    name: inv.name,
                    token: inv.token
                });

                // Update sentAt timestamp
                await db.collection('invitations').doc(invitationId).update({
                    sentAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                alert('Invitation resent successfully!');
                loadInvitations();
            } catch (error) {
                console.error('Error resending invitation:', error);
                alert('Failed to resend invitation: ' + error.message);
            }
        }

        // Load email history
        async function loadEmailHistory() {
            try {
                const snapshot = await db.collection('emailLog')
                    .orderBy('sentAt', 'desc')
                    .limit(10)
                    .get();

                const historyDiv = document.getElementById('emailHistory');

                if (snapshot.empty) {
                    historyDiv.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üìß</div>
                            <p>No emails sent yet</p>
                        </div>
                    `;
                    return;
                }

                let html = '<div style="display: flex; flex-direction: column; gap: 1rem;">';

                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const date = data.sentAt?.toDate().toLocaleString() || 'Unknown';

                    html += `
                        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; border-left: 4px solid #667eea;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <strong style="color: #333;">${data.subject || 'No Subject'}</strong>
                                <span style="color: #666; font-size: 0.9rem;">${date}</span>
                            </div>
                            <div style="color: #666; font-size: 0.9rem;">
                                <strong>To:</strong> ${data.to || 'Unknown'} ${data.clientName ? `(${data.clientName})` : ''}
                            </div>
                            <div style="color: #666; font-size: 0.9rem; margin-top: 0.5rem;">
                                <strong>Type:</strong> ${data.type || 'Custom'}
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
                historyDiv.innerHTML = html;
            } catch (error) {
                console.error('Error loading email history:', error);
            }
        }
    </script>
</body>
</html>
